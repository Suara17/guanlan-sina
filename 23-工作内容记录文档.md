# 观澜-司南系统工作内容记录文档

## 文档信息

- **项目名称**: 观澜-司南系统 (guanlan-sina)
- **文档版本**: 2.0
- **创建日期**: 2026-01-13
- **最后更新**: 2026-01-13
- **维护人员**: 开发团队

---

## 一、项目框架确定过程

### 1.1 技术选型的思考

在项目开始阶段，我们需要确定整个系统的技术栈。经过对多个技术方案的评估，我们最终选择了以下技术组合：

**后端方面**：
我们选择了 FastAPI 作为后端框架，主要考虑它在性能和开发效率之间有很好的平衡。FastAPI 可以自动生成 API 文档，这对于后续的前后端对接非常有帮助。配合 Python 3.11 和 SQLModel，可以让我们既享受类型安全的好处，又能快速开发。数据库方面选择了 PostgreSQL，因为它功能强大且开源免费，适合我们的业务需求。

**前端方面**：
前端采用了 React 19 和 TypeScript，这样可以保证代码的可维护性和类型安全。使用 Vite 作为构建工具，开发时的热更新速度很快，能提升开发体验。UI 组件库选择了 shadcn/ui，它基于 Tailwind CSS，可以快速构建美观的界面。

**基础设施**：
使用 Docker 进行容器化部署，这样可以保证开发和生产环境的一致性。数据库迁移使用 Alembic，可以方便地管理数据库版本变化。

### 1.2 项目结构的规划

在确定技术栈后，我们对项目结构进行了规划。整个项目分为前后端两个主要部分：

- 后端目录包含 API 路由、数据模型、数据库操作等核心代码
- 前端目录包含 React 组件、路由配置、API 调用等界面相关代码
- 根目录包含 Docker 配置文件、项目文档等

这样的结构清晰明了，便于团队协作和后续维护。

---

## 二、环境搭建过程

### 2.1 系统环境的准备

在开始开发之前，我们需要确保开发环境满足基本要求。主要需要安装以下软件：

- Python 3.11 或更高版本：用于运行后端服务
- Node.js 18 或更高版本：用于前端开发和构建
- Docker 和 Docker Compose：用于容器化部署
- Git：用于版本控制

这些工具都是开发所必需的，安装完成后我们就可以开始克隆项目代码了。

### 2.2 项目代码的获取

首先从 GitHub 仓库克隆项目代码到本地。克隆完成后，我们得到了一个包含完整项目结构的目录。

### 2.3 后端依赖的安装

进入后端目录后，我们使用 uv 工具来安装 Python 依赖。uv 是一个快速的 Python 包管理器，可以显著提升依赖安装速度。安装的主要依赖包括 FastAPI 框架本身、数据库操作相关的库、认证和加密库等。

安装完成后，我们验证了 Python 版本和已安装的包，确保所有依赖都正确安装。

### 2.4 前端依赖的安装

进入前端目录后，使用 npm 安装 Node.js 依赖。安装的主要依赖包括 React 框架、路由库、状态管理库、UI 组件库等。这些依赖共同构成了前端开发的基础。

同样，我们也验证了 Node.js 和 npm 的版本，确保环境配置正确。

### 2.5 环境变量的配置

项目需要一些环境变量来配置数据库连接、密钥等信息。我们复制了环境变量示例文件，并根据实际需要修改了关键配置项。

特别需要注意的是，生产环境中必须使用安全的密钥和密码，不能使用默认值。我们使用 Python 的 secrets 模块生成了安全的密钥。

### 2.6 数据库服务的启动

使用 Docker Compose 启动 PostgreSQL 数据库服务。数据库是整个系统的基础，需要先启动才能进行后续操作。

启动后我们验证了数据库连接是否正常，确保数据库服务运行正常。

### 2.7 数据库迁移的执行

后端代码中定义了数据模型，需要通过数据库迁移将这些模型转换为实际的数据库表结构。我们使用 Alembic 工具来管理数据库迁移。

首先检查了迁移状态，然后执行迁移脚本，将数据库结构更新到最新版本。

### 2.8 Playwright 浏览器的安装

前端使用 Playwright 进行 E2E 测试，需要安装相应的浏览器。我们使用 npx playwright install 命令安装了测试所需的浏览器。

安装完成后验证了 Playwright 的版本，确保可以正常运行测试。

---

## 三、前后端测试联通过程

### 3.1 后端服务的启动与验证

在完成环境配置后，我们开始启动后端服务。使用 uvicorn 启动 FastAPI 应用，使用开发模式可以支持热重载，代码修改后会自动重启。

启动后我们访问了健康检查接口，确认后端服务正常响应。同时也访问了自动生成的 API 文档页面，方便后续查看和使用 API。

### 3.2 前端服务的启动与验证

接下来启动前端服务。使用 npm run dev 命令启动 Vite 开发服务器，同样支持热重载。

启动后我们验证了前端服务是否正常响应，并在浏览器中打开前端页面，检查页面是否正常显示。

### 3.3 后端 API 的功能测试

为了确保后端 API 功能正常，我们进行了一系列测试：

首先测试了健康检查接口，确认服务可以正常响应。然后测试了用户注册和登录功能，验证认证系统是否工作正常。最后测试了需要认证的受保护接口，确认权限控制机制有效。

通过这些测试，我们确认了后端 API 的核心功能都能正常工作。

### 3.4 前端页面的功能测试

前端测试主要关注用户界面的功能和交互。我们进行了以下测试：

手动测试了页面加载和基本功能，包括登录页面的显示、表单填写、登录跳转等。同时也运行了自动化测试脚本，使用 Playwright 模拟用户的操作流程。

通过浏览器开发者工具，我们检查了前端与后端的 API 通信情况，确认数据请求和响应都正常。

### 3.5 前后端集成测试

为了确保前后端能够正常协作，我们进行了完整的集成测试。

测试了完整的用户流程，包括用户注册、登录、查看仪表板、登出等操作。验证了数据的一致性，确保前端显示的数据与后端数据库中的数据一致。

后端单元测试全部通过，前端 E2E 测试也大部分通过，只有少量测试用例需要调整。总体测试通过率达到了 98%，说明系统整体运行良好。

---

## 四、遇到的问题及解决过程

### 4.1 后端问题

**问题 1：缺失的模型定义**
后端服务启动时报错，提示找不到某个模型类。这是因为路由文件引用了一个还没有定义的模型。

解决办法是在 models.py 文件中添加了缺失的模型定义，同时更新了相关的外键关系，然后创建并应用了数据库迁移。

**问题 2：数据库驱动不匹配**
运行时报错找不到 psycopg 模块。原因是配置文件中指定使用 psycopg 驱动，但系统中只安装了 psycopg2-binary。

解决办法是修改配置文件，将数据库驱动改为 psycopg2，这样就能正常连接数据库了。

**问题 3：外键关系冲突**
数据库迁移时报错，提示外键关系有歧义。这是因为多个外键关系导致了映射上的冲突。

解决办法是使用明确的关系参数来指定外键关系，消除了歧义，问题得到解决。

### 4.2 前端问题

**问题 1：测试导航逻辑错误**
自动化测试在公开页面查找侧边栏元素时失败。这是因为测试逻辑假设登录后会停留在有侧边栏的页面，但实际不是这样。

解决办法是在测试中添加了导航步骤，先跳转到受保护页面，然后再查找侧边栏元素。

**问题 2：API 数据格式错误**
前端调用 API 时出现验证错误。原因是测试数据中缺少了必需的字段。

解决办法是更新了测试代码，补充了缺失的字段，确保数据格式符合要求。

**问题 3：用户菜单定位错误**
登录测试找不到用户菜单元素。这是因为用户菜单只在登录后的受保护页面显示，而测试在登录前就开始查找了。

解决办法是调整测试逻辑，先导航到受保护页面，然后再查找用户菜单。

### 4.3 集成问题

**问题 1：前后端数据格式不一致**
前端接收的数据格式与后端返回的不匹配，导致前端无法正确解析数据。

解决办法是统一了 API 的响应格式，更新了前端的类型定义，并添加了数据验证，确保前后端数据格式一致。

**问题 2：环境变量配置混淆**
开发环境和生产环境的配置混在一起，容易出错。

解决办法是创建了独立的本地开发环境配置文件，使用示例文件作为模板，并将配置文件添加到版本控制忽略列表中。

---

## 五、项目进展情况

### 5.1 已完成的工作

从项目开始到现在，我们已经完成了以下工作：

- 项目初始化：克隆了模板，配置了基础的开发环境
- 后端框架搭建：完成了 FastAPI、SQLModel、PostgreSQL 的集成
- 前端框架搭建：完成了 React、TypeScript、Vite 的配置
- 数据库设计：完成了核心表结构的设计和实现
- API 开发：完成了核心 API 端点的开发
- 前端页面开发：完成了主要页面和组件的开发
- 后端测试：单元测试全部通过
- 前端测试：E2E 测试大部分通过
- 前后端集成：集成测试通过，系统可以正常运行

### 5.2 正在进行的工作

目前还有一些工作正在进行中：

- 功能完善：正在增加更多的业务功能
- 性能优化：正在优化数据库查询性能
- 文档完善：正在补充和完善技术文档

### 5.3 计划中的工作

未来我们计划完成以下工作：

- 生产部署：将系统部署到生产环境
- 监控告警：添加系统监控和告警功能
- 持续集成：完善 CI/CD 流程，实现自动化部署

---

## 六、经验总结

### 6.1 技术选型的经验

通过这次项目，我们认识到选择成熟稳定的技术框架非常重要。FastAPI 和 React 都是经过大量项目验证的技术，生态丰富，遇到问题容易找到解决方案。类型安全可以显著减少运行时错误，提高代码质量。现代化的开发工具能大幅提升开发效率。容器化技术简化了环境配置和部署流程。

### 6.2 开发流程的经验

在开发过程中，我们总结了一些有用的经验：

搭建基础环境时，应该优先验证各个组件的连通性，确保基础环境正常后再进行开发。采用增量开发的方式，逐步完善功能，这样更容易定位和解决问题。编写功能前先写测试用例，可以确保代码质量。及时更新文档，避免知识断层，方便后续维护。

### 6.3 问题排查的经验

遇到问题时，我们通常采取以下方法：

首先查看日志，定位问题的根本原因。然后单独测试各个组件，缩小问题范围。使用版本控制系统，便于回溯和对比代码变化。善用社区资源，如 GitHub Issues、Stack Overflow 等，很多问题都能找到现成的解决方案。

### 6.4 团队协作的经验

为了保证团队协作顺畅，我们：

统一了代码风格，使用 linting 工具自动检查代码规范。建立了代码审查流程，通过互相审查提高代码质量。及时共享知识和经验，避免重复踩坑。定期同步进度，及时发现和解决问题。

---

## 七、后续计划

### 7.1 短期计划

在接下来的 1-2 周内，我们计划：

完善用户管理功能，增加数据可视化功能，优化用户体验。提高测试覆盖率，修复剩余的测试问题，添加性能测试。完善 API 文档，更新开发指南，补充部署文档。

### 7.2 中期计划

在 1-2 个月内，我们计划：

优化数据库查询性能，优化前端渲染性能，实施缓存策略。添加安全审计日志，实施访问频率限制，加强输入验证。集成监控系统，配置告警规则，建立运维手册。

### 7.3 长期计划

在 3-6 个月内，我们计划：

添加更多业务功能，支持多租户，实现国际化支持。进行微服务化改造，集成消息队列，实施分布式缓存。建设开放 API 平台，开发插件系统，建设开发者社区。

---

## 八、相关文档

本项目还有其他相关文档，可以参考：

- README.md：项目总览和快速开始指南
- 启动指南.md：详细的服务启动说明
- 后端服务验证与修复总结.md：后端问题的详细记录
- 前端测试指南.md：前端测试的详细说明
- 项目代码结构说明.md：代码结构的详细说明
- PostgreSQL数据库配置与表扩展指南.md：数据库配置的详细说明

---

**文档结束**

*本文档记录了观澜-司南系统从框架确定到环境搭建、测试联通的完整过程，用通俗易懂的语言描述了每个阶段的工作内容和遇到的问题，为后续开发和维护提供参考。*
