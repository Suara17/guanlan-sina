# 天筹-浑天跳转问题修复记录

**日期**: 2026-02-12
**问题**: 点击"查看仿真"按钮后无法跳转到浑天仿真页面

---

## 问题现象

### 1. 按钮嵌套错误
```
<button> cannot contain a nested <button>.
```

### 2. 跳转失败
- 点击"查看仿真"按钮
- 页面没有跳转
- 控制台报错

---

## 根本原因

### 问题 1: HTML 规范违反

**位置**: `frontend/pages/Tianchou/components/SolutionCard.tsx`

**原因**:
- 外层使用 `<button>` 包裹整个卡片（用于选中方案）
- 内层使用 `<button>` 实现"查看仿真"功能
- HTML 规范不允许按钮嵌套

### 问题 2: 路由路径错误

**位置**: `frontend/pages/Tianchou/index.tsx` 第 240 行

**错误代码**:
```typescript
navigate('/app/simulation', {
  state: { optimizationResult },
})
```

**问题**:
- 跳转路径: `/app/simulation`
- 实际路由: `/app/huntian` (在 `App.tsx` 中定义)
- 路径不匹配导致跳转失败

---

## 修复方案

### 修复 1: 解决按钮嵌套

**文件**: `frontend/pages/Tianchou/components/SolutionCard.tsx`

**修改内容**:

```typescript
// 修改前
<button
  onClick={onClick}
  className="..."
>
  {/* 内容 */}
  <button onClick={handleViewSimulation}>
    查看仿真
  </button>
</button>

// 修改后
<div
  onClick={onClick}
  className="... cursor-pointer"
  role="button"
  tabIndex={0}
  onKeyDown={(e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault()
      onClick()
    }
  }}
>
  {/* 内容 */}
  <button onClick={handleViewSimulation}>
    查看仿真
  </button>
</div>
```

**改进点**:
1. 外层改为 `<div>`，避免按钮嵌套
2. 添加 `role="button"` 保持语义化
3. 添加 `tabIndex={0}` 支持键盘导航
4. 添加 `onKeyDown` 支持键盘操作（Enter/Space）
5. 添加 `cursor-pointer` 样式提示可点击

### 修复 2: 修正路由路径

**文件**: `frontend/pages/Tianchou/index.tsx` 第 240 行

**修改内容**:

```typescript
// 修改前
navigate('/app/simulation', {
  state: { optimizationResult },
})

// 修改后
navigate('/app/huntian', {
  state: { optimizationResult },
})
```

---

## 验证步骤

### 1. 检查按钮嵌套问题

```bash
# 检查文件内容
grep -n "button\|div" frontend/pages/Tianchou/components/SolutionCard.tsx | head -20

# 应该看到：
# 22:    <div
# 76:          <button
```

### 2. 检查路由路径

```bash
# 检查跳转路径
grep -n "navigate.*huntian" frontend/pages/Tianchou/index.tsx

# 应该看到：
# 240:      navigate('/app/huntian', {
```

### 3. 前端测试

1. 刷新浏览器（Ctrl+Shift+R 强制刷新）
2. 访问天筹页面
3. 创建优化任务并等待完成
4. 点击任意方案卡片的"查看仿真"按钮
5. 验证：
   - ✅ 页面跳转到浑天仿真页面
   - ✅ 控制台无错误
   - ✅ 可视化数据正确加载

### 4. 预期结果

**重工业场景**:
- 自动切换到"线路优化"模式
- 显示 AGV 路径可视化
- 工位节点正确渲染
- AGV 小车沿路径移动

**轻工业场景**:
- 自动切换到"设备重排"模式
- 显示设备布局可视化
- 设备移动动画正常
- 移动路径指示清晰

---

## 相关文件

### 修改的文件

1. `frontend/pages/Tianchou/components/SolutionCard.tsx`
   - 解决按钮嵌套问题
   - 改进可访问性

2. `frontend/pages/Tianchou/index.tsx`
   - 修正路由路径
   - 从 `/app/simulation` 改为 `/app/huntian`

### 相关路由配置

`frontend/App.tsx` 第 128 行:
```typescript
<Route path="/huntian" element={<Huntian />} />
```

---

## 经验教训

### 1. HTML 规范遵守

**教训**: 按钮不能嵌套，违反 HTML 规范会导致 hydration 错误。

**最佳实践**:
- 使用 `<div>` + `role="button"` 替代外层按钮
- 添加键盘事件支持保持可访问性
- 使用 `cursor-pointer` 提示可点击

### 2. 路由路径一致性

**教训**: 跳转路径必须与路由定义一致。

**最佳实践**:
- 在路由配置文件中定义路径常量
- 使用 TypeScript 类型检查路径
- 添加路由测试确保路径正确

### 3. 前端热更新问题

**教训**: Vite 热更新失败时需要强制刷新浏览器。

**解决方案**:
- Ctrl+Shift+R 强制刷新
- 清除浏览器缓存
- 重启开发服务器

---

## 后续优化建议

### 1. 路由常量化

创建 `frontend/constants/routes.ts`:
```typescript
export const ROUTES = {
  DASHBOARD: '/app/',
  SINAN: '/app/sinan',
  GEWU: '/app/gewu',
  HUNTIAN: '/app/huntian',
  TIANCHOU: '/app/tianchou',
  // ...
} as const
```

使用:
```typescript
navigate(ROUTES.HUNTIAN, { state: { optimizationResult } })
```

### 2. 类型安全的路由

使用 TypeScript 确保路由类型安全:
```typescript
type AppRoute = typeof ROUTES[keyof typeof ROUTES]

const navigate = (route: AppRoute, options?: NavigateOptions) => {
  // ...
}
```

### 3. 添加路由测试

```typescript
describe('Navigation', () => {
  it('should navigate from Tianchou to Huntian', () => {
    // 测试跳转逻辑
  })
})
```

---

## 测试清单

- [x] 修复按钮嵌套问题
- [x] 修正路由路径
- [x] 验证代码修改
- [ ] 浏览器端到端测试
- [ ] 重工业场景测试
- [ ] 轻工业场景测试
- [ ] 键盘导航测试
- [ ] 移动端响应式测试

---

**修复完成时间**: 2026-02-12 17:45
**修复人员**: AI Assistant
**状态**: ✅ 代码已修复，待浏览器测试验证
