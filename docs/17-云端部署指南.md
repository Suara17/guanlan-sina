# 天工·弈控 - 云端部署指南

本文档提供多种云端部署方案，从简单到复杂，满足不同场景需求。

---

## 方案一：云服务器 + Docker Compose（推荐，最简单）

### 适用场景
- 中小型项目
- 预算有限
- 需要快速部署
- 需要完全控制服务器

### 推荐平台
- **国内**：阿里云 ECS、腾讯云 CVM、华为云 ECS
- **国外**：AWS EC2、DigitalOcean、Vultr

### 服务器配置建议
- **最低配置**：2核4G内存
- **推荐配置**：4核8G内存
- **操作系统**：Ubuntu 22.04 LTS 或 CentOS 8+
- **带宽**：5Mbps 以上

### 部署步骤

#### 1. 购买云服务器
- 选择合适的云服务商
- 选择服务器配置（2核4G起步）
- 选择操作系统（推荐 Ubuntu 22.04）
- 获取服务器 IP 地址和登录凭证

#### 2. 域名配置
- 购买域名（如：guanlan.example.com）
- 配置 DNS 解析：
  - A 记录：`@` → 服务器 IP
  - A 记录：`*.guanlan.example.com` → 服务器 IP（通配符子域名）

#### 3. 服务器初始化

通过 SSH 连接到服务器：

```bash
ssh root@your-server-ip
```

安装 Docker：

```bash
# 更新系统
apt update && apt upgrade -y

# 安装 Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh

# 安装 Docker Compose
curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# 验证安装
docker --version
docker-compose --version
```

#### 4. 配置 Traefik 反向代理

创建 Traefik 目录：

```bash
mkdir -p /root/code/traefik-public/
cd /root/code/traefik-public/
```

上传 `docker-compose.traefik.yml` 文件到服务器。

创建 Traefik 公共网络：

```bash
docker network create traefik-public
```

设置环境变量：

```bash
# Traefik 登录信息
export USERNAME=admin
export PASSWORD=your_secure_password
export HASHED_PASSWORD=$(openssl passwd -apr1 $PASSWORD)

# 域名和邮箱
export DOMAIN=guanlan.example.com
export EMAIL=admin@example.com
```

启动 Traefik：

```bash
docker compose -f docker-compose.traefik.yml up -d
```

#### 5. 部署应用

创建项目目录：

```bash
mkdir -p /root/code/guanlan-sina/
cd /root/code/guanlan-sina/
```

上传项目文件：
- `docker-compose.yml`
- `.env` 文件（包含所有环境变量）
- `backend/` 目录
- `frontend/` 目录

配置 `.env` 文件：

```bash
# 环境类型
ENVIRONMENT=production

# 域名配置
DOMAIN=guanlan.example.com
FRONTEND_HOST=https://dashboard.guanlan.example.com

# 堆栈名称
STACK_NAME=guanlan-sina

# CORS 配置
BACKEND_CORS_ORIGINS=https://dashboard.guanlan.example.com,https://guanlan.example.com

# 安全密钥（使用以下命令生成：python -c "import secrets; print(secrets.token_urlsafe(32))"）
SECRET_KEY=your_generated_secret_key_here

# 超级管理员
FIRST_SUPERUSER=admin@example.com
FIRST_SUPERUSER_PASSWORD=your_secure_password

# SMTP 邮件配置（可选）
SMTP_HOST=smtp.example.com
SMTP_USER=your_smtp_user
SMTP_PASSWORD=your_smtp_password
EMAILS_FROM_EMAIL=noreply@example.com

# PostgreSQL 配置
POSTGRES_SERVER=db
POSTGRES_PORT=5432
POSTGRES_DB=app
POSTGRES_USER=app
POSTGRES_PASSWORD=your_db_password

# Sentry（可选）
SENTRY_DSN=
```

启动应用：

```bash
docker compose up -d
```

#### 6. 验证部署

访问以下 URL 验证部署：

- **前端**：https://dashboard.guanlan.example.com
- **后端 API**：https://api.guanlan.example.com/docs
- **Traefik 仪表板**：https://traefik.guanlan.example.com
- **数据库管理**：https://adminer.guanlan.example.com

### 成本估算
- **阿里云 2核4G**：约 60-80 元/月
- **腾讯云 2核4G**：约 60-80 元/月
- **带宽**：5Mbps 约 50-100 元/月
- **域名**：约 50-100 元/年

**总成本**：约 100-200 元/月

### 优点
- 成本低
- 完全控制服务器
- 项目已配置好 Docker Compose，直接可用
- 灵活性高

### 缺点
- 需要自己管理服务器维护、安全更新
- 需要配置 SSL 证书（Traefik 自动处理）

---

## 方案二：PaaS 平台（一键部署）

### 适用场景
- 需要快速部署
- 不想管理服务器
- 需要自动扩缩容
- 商业项目快速上线

### 推荐平台
- **Render**（推荐，支持 Docker）
- **Railway**（推荐，支持 Docker）
- **Zeabur**（国内访问友好）
- **Fly.io**（全球分布）

### 部署步骤（以 Render 为例）

#### 1. 准备工作
- 注册 Render 账号
- 连接 GitHub 仓库
- 准备 `.env` 文件

#### 2. 部 PostgreSQL 数据库

在 Render 控制台：
1. 点击 "New" → "Database"
2. 选择 PostgreSQL
3. 选择实例类型（Free 或 Paid）
4. 创建数据库
5. 记录数据库连接信息

#### 3. 部署后端

在 Render 控制台：
1. 点击 "New" → "Web Service"
2. 连接 GitHub 仓库
3. 配置构建和部署：
   - **Root Directory**：`backend`
   - **Build Command**：`pip install -r requirements.txt`
   - **Start Command**：`uvicorn app.main:app --host 0.0.0.0 --port $PORT`
4. 配置环境变量：
   ```
   DATABASE_URL=postgresql://user:pass@host:port/dbname
   SECRET_KEY=your_secret_key
   ENVIRONMENT=production
   ```
5. 点击 "Create Web Service"

#### 4. 部署前端

在 Render 控制台：
1. 点击 "New" → "Static Site"
2. 连接 GitHub 仓库
3. 配置构建和部署：
   - **Root Directory**：`frontend`
   - **Build Command**：`npm run build`
   - **Publish Directory**：`dist`
4. 配置环境变量：
   ```
   VITE_API_URL=https://your-backend-url.onrender.com
   ```
5. 点击 "Create Static Site"

#### 5. 配置自定义域名（可选）

在 Render 控制台：
1. 选择服务
2. 点击 "Settings" → "Domains"
3. 添加自定义域名
4. 配置 DNS 记录

### 成本估算（Render）
- **免费版**：
  - 数据库：512MB，90天休眠
  - Web Service：512MB，15分钟休眠
- **付费版**：
  - 数据库：7美元/月（1GB）
  - Web Service：7美元/月（512MB）

**总成本**：约 14-50 美元/月（100-360 元/月）

### 优点
- 一键部署，几分钟上线
- 自动 HTTPS
- 自动数据库备份
- 自动扩缩容
- 支持多个环境（staging/production）
- 零运维

### 缺点
- 月费相对较高
- 平台锁定
- 免费版有休眠限制

---

## 方案三：Serverless 平台（最省心）

### 适用场景
- 低流量应用
- 不想管理服务器
- 按需付费
- 快速原型验证

### 推荐平台
- **前端**：Vercel、Netlify
- **后端**：Railway、Render、Vercel Serverless Functions
- **数据库**：Supabase、Neon、PlanetScale

### 部署步骤

#### 1. 前端部署到 Vercel

```bash
# 安装 Vercel CLI
npm install -g vercel

# 登录
vercel login

# 部署
cd frontend
vercel
```

或通过 Vercel 控制台：
1. 连接 GitHub 仓库
2. 导入项目
3. 配置构建设置
4. 自动部署

#### 2. 后端部署到 Railway

```bash
# 安装 Railway CLI
npm install -g @railway/cli

# 登录
railway login

# 初始化项目
railway init

# 添加 PostgreSQL
railway add postgresql

# 部署后端
railway up
```

#### 3. 数据库配置

使用 Supabase 或 Neon：
1. 注册账号
2. 创建 PostgreSQL 数据库
3. 获取连接字符串
4. 配置环境变量

### 成本估算
- **Vercel 前端**：免费（个人项目）
- **Railway 后端**：5美元/月起
- **Supabase 数据库**：免费（500MB）

**总成本**：约 5-20 美元/月（35-140 元/月）

### 优点
- 几乎零运维
- 按需付费，成本极低
- 自动 HTTPS
- 自动扩缩容
- 全球 CDN

### 缺点
- 冷启动延迟（Serverless）
- 有并发限制
- 数据库需要单独付费
- 不适合高流量应用

---

## 方案四：混合部署（成本最优）

### 适用场景
- 需要平衡成本和性能
- 前端流量大，后端流量小
- 预算有限

### 部署架构

```
前端 → Vercel/Netlify（免费）
后端 → 云服务器 ECS（60元/月）
数据库 → 云厂商 RDS（200元/月）
```

### 部署步骤

#### 1. 前端部署到 Vercel

```bash
cd frontend
vercel --prod
```

#### 2. 后端部署到云服务器

参考方案一的步骤，但只部署后端和数据库。

#### 3. 数据库使用云 RDS

- 阿里云 RDS PostgreSQL
- 腾讯云 PostgreSQL
- AWS RDS

### 成本估算
- **前端 Vercel**：免费
- **后端 阿里云 ECS**：60元/月（2核4G）
- **数据库 阿里云 RDS**：200元/月（基础版）

**总成本**：约 260 元/月

### 优点
- 前端免费托管
- 后端按需付费
- 数据库自动备份
- 成本相对较低

### 缺点
- 需要多个平台管理
- 配置稍复杂

---

## 方案五：Kubernetes（企业级）

### 适用场景
- 企业级应用
- 需要高可用性
- 需要自动扩缩容
- 多环境管理

### 推荐平台
- **阿里云 ACK**
- **腾讯云 TKE**
- **AWS EKS**
- **Google Cloud GKE**

### 部署步骤

#### 1. 创建 Kubernetes 集群

在云控制台创建集群：
- 选择节点规格
- 选择节点数量（至少 3 个）
- 配置网络和存储

#### 2. 配置 kubectl

```bash
# 安装 kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
chmod +x kubectl
sudo mv kubectl /usr/local/bin/

# 配置集群访问
kubectl config use-context your-cluster
```

#### 3. 转换 Docker Compose 为 Kubernetes

使用 Kompose 工具：

```bash
# 安装 Kompose
curl -L https://github.com/kubernetes/kompose/releases/download/v1.28.0/kompose-linux-amd64 -o kompose
chmod +x kompose
sudo mv kompose /usr/local/bin/

# 转换配置
kompose convert -f docker-compose.yml
```

#### 4. 部署应用

```bash
# 部署数据库
kubectl apply -f postgres-deployment.yaml
kubectl apply -f postgres-service.yaml

# 部署后端
kubectl apply -f backend-deployment.yaml
kubectl apply -f backend-service.yaml

# 部署前端
kubectl apply -f frontend-deployment.yaml
kubectl apply -f frontend-service.yaml
```

#### 5. 配置 Ingress

```bash
# 安装 Nginx Ingress Controller
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/cloud/deploy.yaml

# 配置 Ingress 规则
kubectl apply -f ingress.yaml
```

### 成本估算
- **Kubernetes 集群**：500-1000 元/月
- **节点（3个）**：300-600 元/月
- **负载均衡**：100-200 元/月

**总成本**：约 900-1800 元/月

### 优点
- 自动扩缩容
- 高可用性
- 滚动更新
- 多环境管理
- 云厂商提供运维支持

### 缺点
- 成本较高
- 学习曲线较陡
- 需要转换配置文件
- 运维复杂度高

---

## 方案对比总结

| 方案 | 月成本 | 复杂度 | 运维负担 | 适用场景 |
|------|--------|--------|----------|----------|
| **方案一：云服务器 + Docker Compose** | 100-200元 | 低 | 中 | 个人项目、小团队 |
| **方案二：PaaS 平台** | 100-360元 | 极低 | 低 | 商业项目、快速上线 |
| **方案三：Serverless** | 35-140元 | 低 | 极低 | 低流量应用、原型验证 |
| **方案四：混合部署** | 260元 | 中 | 中 | 成本敏感、性能要求 |
| **方案五：Kubernetes** | 900-1800元 | 高 | 低 | 企业级、高可用 |

---

## 推荐方案选择

### 根据项目阶段选择

| 项目阶段 | 推荐方案 |
|----------|----------|
| **原型验证** | 方案三：Serverless |
| **个人项目** | 方案一：云服务器 + Docker Compose |
| **小团队项目** | 方案一：云服务器 + Docker Compose |
| **商业项目 MVP** | 方案二：PaaS 平台 |
| **商业项目正式版** | 方案四：混合部署 |
| **企业级应用** | 方案五：Kubernetes |

### 根据预算选择

| 月预算 | 推荐方案 |
|--------|----------|
| **50元以下** | 方案三：Serverless（免费版） |
| **50-200元** | 方案一：云服务器 + Docker Compose |
| **200-500元** | 方案二：PaaS 平台 或 方案四：混合部署 |
| **500元以上** | 方案五：Kubernetes |

### 根据技术能力选择

| 技术能力 | 推荐方案 |
|----------|----------|
| **无运维经验** | 方案二：PaaS 平台 或 方案三：Serverless |
| **有基础运维经验** | 方案一：云服务器 + Docker Compose |
| **有丰富运维经验** | 方案四：混合部署 或 方案五：Kubernetes |

---

## 安全建议

### 1. 服务器安全
- 定期更新系统和软件包
- 配置防火墙（只开放必要端口）
- 禁用 root 登录，使用 SSH 密钥认证
- 安装 fail2ban 防止暴力破解
- 定期备份数据

### 2. 应用安全
- 使用强密码（至少16位，包含大小写字母、数字、特殊字符）
- 定期更新依赖包
- 配置 HTTPS（Let's Encrypt）
- 启用 CORS 白名单
- 使用环境变量管理敏感信息

### 3. 数据库安全
- 使用强密码
- 限制数据库访问 IP
- 定期备份数据
- 启用 SSL 连接

### 4. 监控和日志
- 配置应用监控（Sentry、Prometheus）
- 收集应用日志
- 设置告警规则
- 定期检查日志

---

## 监控和维护

### 1. 健康检查

项目已配置健康检查端点：
- 后端：`/api/v1/utils/health-check/`
- Traefik 会自动检查服务状态

### 2. 日志管理

查看容器日志：

```bash
# 查看所有服务日志
docker compose logs -f

# 查看特定服务日志
docker compose logs -f backend
docker compose logs -f frontend
docker compose logs -f db
```

### 3. 数据备份

定期备份数据库：

```bash
# 手动备份
docker compose exec db pg_dump -U app app > backup.sql

# 自动备份（添加到 crontab）
0 2 * * * docker compose exec db pg_dump -U app app > /backup/backup_$(date +\%Y\%m\%d).sql
```

### 4. 更新部署

更新应用：

```bash
# 拉取最新代码
git pull

# 重新构建并部署
docker compose up -d --build

# 清理旧镜像
docker image prune -f
```

---

## 故障排查

### 常见问题

#### 1. 容器无法启动
```bash
# 查看容器日志
docker compose logs backend

# 检查环境变量
docker compose config

# 检查网络连接
docker network ls
docker network inspect traefik-public
```

#### 2. 数据库连接失败
```bash
# 检查数据库状态
docker compose ps db

# 查看数据库日志
docker compose logs db

# 测试数据库连接
docker compose exec db psql -U app -d app
```

#### 3. HTTPS 证书问题
```bash
# 检查 Traefik 日志
docker compose -f docker-compose.traefik.yml logs

# 检查证书状态
docker compose exec traefik ls /letsencrypt/
```

#### 4. 前端无法访问后端
```bash
# 检查 CORS 配置
echo $BACKEND_CORS_ORIGINS

# 检查后端服务状态
docker compose ps backend

# 测试后端 API
curl https://api.your-domain.com/api/v1/utils/health-check/
```

---

## 性能优化

### 1. 数据库优化
- 添加数据库索引
- 配置连接池
- 定期清理无用数据
- 使用 Redis 缓存

### 2. 后端优化
- 增加 Worker 数量
- 启用 Gzip 压缩
- 使用 CDN 加速静态资源
- 配置负载均衡

### 3. 前端优化
- 启用代码分割
- 使用懒加载
- 优化图片资源
- 配置 CDN

---

## 扩展性

### 水平扩展
```bash
# 增加后端实例
docker compose up -d --scale backend=3

# 使用负载均衡器
# 配置 Nginx 或 HAProxy
```

### 垂直扩展
- 升级服务器配置
- 增加内存和 CPU
- 使用 SSD 存储

---

## 成本优化

### 1. 使用预留实例
- 云厂商提供预留实例折扣
- 长期使用可节省 30-50%

### 2. 使用 Spot 实例
- AWS/GCP 提供 Spot 实例
- 价格低至普通实例的 10%

### 3. 优化资源使用
- 监控资源使用率
- 及时释放闲置资源
- 使用自动扩缩容

---

## 总结

根据项目需求和预算，选择合适的部署方案：

1. **最简单、最便宜**：方案一（云服务器 + Docker Compose）
2. **最省心、零运维**：方案二（PaaS 平台）
3. **成本最优**：方案四（混合部署）
4. **企业级、高可用**：方案五（Kubernetes）

对于天工·弈控项目，我建议：
- **个人项目/小团队**：方案一（云服务器 + Docker Compose）
- **商业项目快速上线**：方案二（PaaS 平台）
- **成本敏感的商业项目**：方案四（混合部署）

---

*文档版本：1.0 | 更新日期：2026-01-26*