
## 1. 项目背景与目标

### 1.1 背景
当前系统各模块功能相对独立，业务流程不够连贯。用户在实际使用中难以形成完整的"发现问题 → 分析原因 → 决策方案 → 执行落地"闭环体验。

### 1.2 目标
构建两条核心业务主线，实现系统端到端的智能化闭环：

1. **异常处理路线**：可视化发现问题 → 格物根因分析 → 智能决策推荐 → 方案执行
2. **优化路线**：生产计划监控 → 工单切换预警 → 天筹布局优化

同时增加**异常模拟**功能，用于演示系统运行流程。

---

## 2. 用户故事

### 2.1 异常处理路线

| 角色 | 用户故事 | 验收标准 |
|------|----------|----------|
| 生产主管 | 我希望在Dashboard看到异常后，点击就能查看详细原因 | 点击异常跳转格物页面，展示完整根因分析链 |
| 质量工程师 | 我希望在格物页面看完根因后，能一键获取解决方案 | 格物页面有"智能决策"按钮，点击跳转司南展示方案 |
| 设备工程师 | 我希望系统能自动给出多个解决方案，并显示各项成本预估 | 每个方案显示：维修成本、交期影响、品质风险、停产损失、综合期望损失 |
| 车间主任 | 我希望能快速对比各方案，选择最优方案后直接执行 | 司南页面可选择方案，点击"采纳并执行"跳转智行 |

### 2.2 优化路线

| 角色 | 用户故事 | 验收标准 |
|------|----------|----------|
| 计划员 | 我希望看到当前工单的详细信息和生产进度 | 显示：工单号、产品编号、计划数量、实际数量、预计完单时间 |
| 生产主管 | 我希望在产品切换时收到预警提示 | 产品编号变化时自动弹窗预警 |
| 工艺工程师 | 我希望能一键获取新产品的最优布局方案 | 点击优化跳转天筹，自动传入参数执行优化 |

### 2.3 异常模拟

| 角色 | 用户故事 | 验收标准 |
|------|----------|----------|
| 销售顾问 | 我希望能模拟各种异常场景，向客户展示系统流程 | 至少10个预设情境，可选择模拟 |
| 售前工程师 | 我希望模拟数据合理可信，让客户直观理解价值 | 每个情境有完整的成本、时间、风险数据 |

---

## 3. 功能需求详述

### 3.1 异常处理路线

#### 页面跳转流程图

```
┌─────────────┐    点击异常项    ┌─────────────┐   点击"智能决策"   ┌─────────────┐
│  Dashboard  │ ─────────────→ │    格物     │ ─────────────────→ │    司南     │
│  (生产可视化) │               │  (知识图谱)  │                    │  (智能诊断)  │
│  看到异常    │               │  查看根因    │                    │  展示方案    │
└─────────────┘                └─────────────┘                     └──────┬──────┘
                                                                          │
                                     ┌─────────────┐                      │
                                     │    智行     │ ←────────────────────┘
                                     │  (执行监控)  │   点击"采纳并执行"
                                     │  落地执行    │
                                     └─────────────┘
```

**流程说明**：

| 步骤 | 页面 | 用户操作 | 系统响应 |
|------|------|----------|----------|
| 1 | Dashboard | 发现异常，点击异常项 | 跳转格物页面，传入异常ID |
| 2 | 格物 | 查看知识图谱，逐个点击原因节点查看详情 | Neo4j返回根因分析链 |
| 3 | 格物 | 点击"智能决策"按钮 | 调用算法生成多方案，跳转司南展示 |
| 4 | 司南 | 查看方案A/B/C，对比成本矩阵 | 展示每个方案的详细成本数据 |
| 5 | 司南 | 选择某个方案，点击"采纳并执行" | 创建工单，跳转智行页面 |
| 6 | 智行 | 监控执行进度、日志、设备状态 | 实时展示执行情况 |

#### 3.1.1 Dashboard异常入口优化

**功能描述**：
- 异常列表支持点击跳转格物页面
- 异常等级视觉区分（严重/错误/警告）
- 异常卡片显示关键信息摘要

**交互流程**：
```
用户在Dashboard看到异常列表
    ↓
点击某个异常项
    ↓
跳转到格物页面（带异常ID参数）
    ↓
格物页面自动加载该异常的根因分析
```

**UI变更**：
- `AnomalyList.tsx`：增加点击事件，跳转 `/app/gewu?anomaly_id=xxx`
- 异常卡片hover效果增强，鼠标变为手型

#### 3.1.2 格物根因分析增强

**功能描述**：
- 异常详情自动加载关联知识图谱
- 支持逐个原因节点点击查看详情
- **新增"智能决策"按钮**：点击后跳转司南，展示多个解决方案

**页面布局**：
```
┌─────────────────────────────────────────────────────────────┐
│ 格物 · 知识图谱                                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  [知识图谱可视化区域]                                        │
│   异常节点 → 原因节点1 → 原因节点2 → ... → 根因节点          │
│   (可逐个点击查看详情)                                       │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│ [节点详情面板]                                               │
│ 点击某个节点后显示：节点名称、描述、置信度、影响程度等        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  🤖 智能决策  │  点击获取解决方案  │                  │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**数据流程**：
```
异常ID → Neo4j查询 → 返回原因链 → 前端渲染知识图谱
点击"智能决策" → 跳转司南页面 → 司南调用方案生成API → 展示方案列表
```

**API扩展**：
```python
GET /api/v1/knowledge-graph/analysis/anomaly/{anomaly_id}
# 返回：异常详情 + 原因链 + 每个原因的详细信息

GET /api/v1/solutions?anomaly_id={anomaly_id}
# 返回：该异常关联的所有解决方案（含成本矩阵）
```

#### 3.1.3 司南方案展示重构

**功能描述**：
- 从格物跳转过来后，自动展示该异常的多个解决方案
- 方案卡片展示完整成本矩阵
- 方案对比视图
- **一键采纳执行**：跳转智行页面落地执行

**方案成本矩阵**：

| 字段 | 说明 | 数据类型 |
|------|------|----------|
| repair_cost | 维修成本（元） | float |
| delivery_impact_cost | 交期影响成本（元） | float |
| quality_risk_cost | 品质风险成本（元） | float |
| downtime_cost | 停产损失（元） | float |
| total_expected_loss | 综合期望损失（元） | float |
| implementation_time | 实施时间（小时） | float |
| success_rate | 成功概率（%） | float |
| risk_level | 风险等级 | enum: low/medium/high |

**UI设计**：
```
┌─────────────────────────────────────────────────────────────┐
│ 方案 A：立即停机更换吸嘴                    [AI推荐]        │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│ │ 维修成本    │ │ 交期影响    │ │ 品质风险    │ │停产损失 │ │
│ │ ¥2,500     │ │ ¥8,000     │ │ ¥500       │ │¥12,000  │ │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
│                                                              │
│ 综合期望损失: ¥23,000  │  实施时间: 15min  │  成功率: 95%  │
│                                                              │
│ [查看详情]                              [采纳并执行]        │
└─────────────────────────────────────────────────────────────┘
```

#### 3.1.4 方案采纳与智行执行

**功能描述**：
- 用户在司南页面选择方案后，点击"采纳并执行"
- 系统自动创建工单（WorkOrder）
- 跳转到智行页面，展示执行任务详情
- 智行页面支持暂停/恢复/完成确认等操作

**交互流程**：
```
用户在司南页面对比方案A/B/C
    ↓
选择某个方案，点击"采纳并执行"按钮
    ↓
系统创建WorkOrder，状态为"pending"
    ↓
自动跳转到智行页面（/app/zhixing?order_id=xxx）
    ↓
智行页面展示：
  - 执行任务信息（方案名称、预计时间、负责人）
  - 实时进度条
  - 执行日志流
  - 设备状态图
  - 操作按钮（开始/暂停/恢复/完成确认）
```

**智行页面执行状态**：
```
┌─────────────────────────────────────────────────────────────┐
│ 智行 · 执行监控                                              │
├─────────────────────────────────────────────────────────────┤
│ 任务：方案A - 立即停机更换吸嘴                               │
│ 状态：执行中 ████████████░░░░ 65%                           │
│ 预计完成时间：剩余 8 分钟                                    │
├─────────────────────────────────────────────────────────────┤
│ [实时日志]                                                   │
│ 14:32:15 开始执行任务...                                     │
│ 14:32:18 已通知设备#5停机                                    │
│ 14:32:45 正在更换吸嘴 N-204...                               │
│ 14:33:02 吸嘴更换完成，开始调试...                           │
├─────────────────────────────────────────────────────────────┤
│ [操作]                                                       │
│   [暂停]    [取消任务]    [标记完成]                         │
└─────────────────────────────────────────────────────────────┘
```

**数据流程**：
```
司南点击"采纳并执行"
    ↓
POST /api/v1/solutions/{id}/adopt
    ↓
创建 WorkOrder 记录
    ↓
返回 work_order_id
    ↓
跳转智行页面：/app/zhixing?order_id=xxx
```

---

### 3.2 优化路线

#### 3.2.1 生产计划模块（新增）

**位置**：Dashboard页面新增模块

**功能描述**：
- 显示当前工单信息
- 显示下一工单预览
- 产品切换预警

**数据字段**：

| 字段 | 说明 |
|------|------|
| work_order_no | 当前工单号 |
| product_id | 产品编号 |
| product_name | 产品名称 |
| process_flow_id | 工艺流程ID |
| planned_quantity | 计划生产数量 |
| actual_quantity | 实际生产数量 |
| estimated_completion_time | 预计完单时间 |
| progress_percent | 完成进度（%） |

**UI设计**：
```
┌─────────────────────────────────────────────────────────────┐
│ 📋 生产计划                                   [详情] [优化]  │
├─────────────────────────────────────────────────────────────┤
│ 当前工单: WO-20260223-001        产品: PCB-A型              │
│ ─────────────────────────────────────────────────────────── │
│ 计划数量: 5000    实际数量: 3250    进度: 65%               │
│ 预计完单: 2026-02-23 18:00                                  │
│                                                              │
│ ┌─ 下一工单预览 ─────────────────────────────────────────┐  │
│ │ WO-20260223-002  │  产品: PCB-B型  │  ⚠️ 产品变化预警  │  │
│ └────────────────────────────────────────────────────────┘  │
│ [一键优化布局] ← 仅产品切换时显示                           │
└─────────────────────────────────────────────────────────────┘
```

#### 3.2.2 工艺流程数据模型（新增）

**数据模型**：

```python
class ProcessFlow(SQLModel, table=True):
    """工艺流程定义"""
    __tablename__ = "process_flows"
    
    id: uuid.UUID = Field(default_factory=uuid.uuid4, primary_key=True)
    product_id: uuid.UUID  # 关联产品
    flow_name: str  # 流程名称
    version: str  # 版本号
    
    # 工序列表 (JSON)
    steps: list[dict] = Field(default=[], sa_column=Column(JSONB))
    # 示例: [{"step": 1, "name": "印刷", "station_type": "printer", "cycle_time": 30}, ...]
    
    # 设备约束
    equipment_requirements: dict = Field(default={}, sa_column=Column(JSONB))
    
    created_at: datetime = Field(default_factory=datetime.utcnow)


class Product(SQLModel, table=True):
    """产品信息"""
    __tablename__ = "products"
    
    id: uuid.UUID = Field(default_factory=uuid.uuid4, primary_key=True)
    product_code: str = Field(unique=True, index=True)  # 产品编号
    product_name: str
    category: str | None  # 产品类别
    
    # 关联工艺流程
    default_flow_id: uuid.UUID | None = Field(default=None, foreign_key="process_flows.id")
    
    # 产品特性
    dimensions: dict | None = Field(default=None, sa_column=Column(JSONB))  # 尺寸
    required_stations: list[str] = Field(default=[], sa_column=Column(ARRAY(String)))
    
    created_at: datetime = Field(default_factory=datetime.utcnow)
```

#### 3.2.3 产品切换预警与优化触发

**功能描述**：
- 工单切换时自动检测产品变化
- 产品变化时弹出预警
- 点击"一键优化"跳转天筹

**预警逻辑**：
```python
def check_product_change(current_plan: ProductionPlan, next_plan: ProductionPlan) -> dict:
    """
    检查产品切换
    
    Returns:
        {
            "change_detected": bool,
            "current_product": str,
            "next_product": str,
            "requires_optimization": bool,  # 工艺流程差异大时为True
            "flow_differences": list[str]
        }
    """
    if current_plan.product_id != next_plan.product_id:
        # 获取两个产品的工艺流程
        current_flow = get_process_flow(current_plan.product_id)
        next_flow = get_process_flow(next_plan.product_id)
        
        # 比较工序差异
        differences = compare_flows(current_flow, next_flow)
        
        return {
            "change_detected": True,
            "current_product": current_plan.product_name,
            "next_product": next_plan.product_name,
            "requires_optimization": len(differences) > 2,
            "flow_differences": differences
        }
    return {"change_detected": False}
```

**跳转天筹参数**：
```typescript
interface OptimizationParams {
  mode: 'product_switch'
  current_product_id: string
  next_product_id: string
  current_layout: LayoutData
  process_flow: ProcessFlow
  line_id: string
}
```

#### 3.2.4 已确认事项

> **状态**：已确认 ✓
> **确认日期**：2026-02-24

**问题一：现有天筹系统与产品切换优化的差异**

| 对比维度 | PRD需求 | 现有天筹实现 |
|---------|---------|-------------|
| **触发条件** | 产品切换（产品编号变化） | 手动选择轻/重工业 |
| **优化依据** | 产品工艺流程差异 | 行业类型（轻/重工业） |
| **输入参数** | 现有产品ID + 下一个产品ID | 车间尺寸、设备数、AGV数等 |
| **优化目标** | 根据工艺流程调整产线布局 | 通用的物料搬运/AGV路径优化 |
| **数据来源** | 产品表、工艺流程表 | 用户手动输入参数 |

**问题二：数据模型缺失**

现有数据库缺少：
- `Product` 表（产品信息）
- `ProcessFlow` 表（工艺流程定义）

`ProductionPlan` 虽有 `product_id` 字段，但没有关联的产品表。

**问题三：算法与工艺流程脱节**

现有算法的 `product_lines` 参数仅为设备分组，无法表达：
- 工序顺序（如：印刷→贴片→回流焊→检测）
- 每道工序的设备类型要求
- 工序间的物料流转关系

---

**已确认问题清单**：

| 序号 | 问题 | 确认结果 |
|------|------|----------|
| 1 | 产品信息和工艺流程数据从哪里来？ | **已确认**：有既定的流程文件直接导入，新品上线时手工录入。新增产品较少，手动录入工作量很小。 |
| 2 | 产品切换优化具体调整哪些内容？ | **已确认**：不同产品情况不同，可能只改变物理位置、或只改变路径、或两者都变、或都不变。需要支持全部场景。 |
| 3 | 实施方案选择？ | **已确认**：默认在切换时预警，系统管理人员不做特殊操作则不干预。如点击查看优化方案栏目，则提供具体方案。**开发建议**：每次切换都默认生成优化方案，不点击查看则不显示。 |
| 4 | 是否需要保留现有天筹的手动模式？ | **已确认**：必须保留手动选项，不可能完全由系统自动解决。 |

---

**确定实施方案**：

基于以上确认结果，采用**优化后的折中方案**：

| 特性 | 实现方式 |
|------|----------|
| **数据导入** | 既定流程文件直接导入 + 新品手动录入 |
| **切换预警** | 产品切换时自动预警弹窗 |
| **优化方案生成** | 每次切换默认生成优化方案（后台） |
| **方案展示** | 用户点击查看时才显示详细方案 |
| **手动模式** | 保留手动输入模式，作为备选方案 |
| **优化内容** | 支持物理位置、AGV路径、产线配置等多种调整场景 |

**开发要点**：
1. 新增 `Product` 和 `ProcessFlow` 模型，支持导入和手动录入
2. 产品切换时自动触发后台优化计算，结果暂存
3. 前端预警弹窗提供"查看优化方案"按钮，点击后展示已计算结果
4. 天筹页面保留手动模式入口，允许用户自主输入参数

---

### 3.3 异常模拟功能

#### 3.3.1 功能入口

**位置**：Dashboard → 司南助手 → "异常模拟"按钮（仅演示/管理员可见）

#### 3.3.2 预设情境（至少10个）

| 情境ID | 情境名称 | 触发条件 | 模拟数据 |
|--------|----------|----------|----------|
| SIM-001 | 锡焊不到位连续10个不良 | 手动选择 | 维修成本¥3,000、交期18h后、成功率85% |
| SIM-002 | 贴片机抛料率超8% | 手动选择 | 维修成本¥2,500、交期15min、成功率92% |
| SIM-003 | 回流焊温度异常 | 手动选择 | 维修成本¥1,800、交期2h、成功率88% |
| SIM-004 | AOI误检率过高 | 手动选择 | 维修成本¥500、交期10min、成功率95% |
| SIM-005 | 印刷机刮刀磨损 | 手动选择 | 维修成本¥4,000、交期4h、成功率80% |
| SIM-006 | AGV路径冲突 | 手动选择 | 维修成本¥0、交期30min、成功率100% |
| SIM-007 | 波峰焊锡炉液位低 | 手动选择 | 维修成本¥6,000、交期8h、成功率75% |
| SIM-008 | 贴片吸嘴堵塞 | 手动选择 | 维修成本¥800、交期5min、成功率98% |
| SIM-009 | 钢网张力不足 | 手动选择 | 维修成本¥1,200、交期1h、成功率90% |
| SIM-010 | 元件供料器卡料 | 手动选择 | 维修成本¥300、交期3min、成功率99% |

#### 3.3.3 情境数据结构

```python
class SimulationScenario(SQLModel, table=True):
    """异常模拟情境"""
    __tablename__ = "simulation_scenarios"
    
    id: uuid.UUID = Field(default_factory=uuid.uuid4, primary_key=True)
    scenario_code: str = Field(unique=True)  # SIM-001
    scenario_name: str
    description: str
    
    # 异常信息
    anomaly_type: str  # 异常类型
    anomaly_location: str  # 发生位置
    severity: str  # 严重程度
    
    # 根因数据
    root_cause: str
    root_cause_confidence: float  # 置信度
    
    # 方案数据 (多个方案)
    solutions: list[dict] = Field(default=[], sa_column=Column(JSONB))
    # 示例:
    # [{
    #   "id": "A",
    #   "title": "方案A：立即更换吸嘴",
    #   "repair_cost": 2500,
    #   "delivery_impact_hours": 0.25,
    #   "delivery_impact_cost": 8000,
    #   "quality_risk_cost": 500,
    #   "downtime_cost": 12000,
    #   "total_expected_loss": 23000,
    #   "implementation_time_hours": 0.25,
    #   "success_rate": 0.92,
    #   "risk_level": "low",
    #   "is_recommended": true
    # }]
    
    # 知识图谱数据
    knowledge_graph_nodes: list[dict] = Field(default=[], sa_column=Column(JSONB))
    
    created_at: datetime = Field(default_factory=datetime.utcnow)
```

#### 3.3.4 模拟交互流程

```
1. 用户点击"异常模拟"
   ↓
2. 弹出情境选择面板（卡片式展示10+情境）
   ↓
3. 选择情境 → 显示情境详情预览
   ↓
4. 确认模拟 → 跳转异常模拟子页面
   ↓
5. 自动展示：
   - 模拟异常信息
   - 格物根因分析图
   - 多方案对比（含成本矩阵）
   ↓
6. 用户可选择方案 → 演示执行流程
```

#### 3.3.5 UI设计

**情境选择面板**：
```
┌─────────────────────────────────────────────────────────────┐
│ 🔬 异常模拟 - 选择情境                              [关闭]  │
├─────────────────────────────────────────────────────────────┤
│ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐      │
│ │ SIM-001       │ │ SIM-002       │ │ SIM-003       │      │
│ │ 锡焊不到位    │ │ 贴片抛料率高  │ │ 回流焊温度异常│      │
│ │ ⚠️ 高影响     │ │ ⚠️ 高影响     │ │ ⚡ 中等影响   │      │
│ └───────────────┘ └───────────────┘ └───────────────┘      │
│ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐      │
│ │ SIM-004       │ │ SIM-005       │ │ SIM-006       │      │
│ │ AOI误检率高   │ │ 印刷刮刀磨损  │ │ AGV路径冲突   │      │
│ │ ⚡ 中等影响   │ │ 🔴 严重影响   │ │ ⚡ 中等影响   │      │
│ └───────────────┘ └───────────────┘ └───────────────┘      │
│ ... 更多情境 ...                                            │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. 数据模型变更

### 4.1 新增模型

| 模型 | 说明 | 文件位置 |
|------|------|----------|
| `Product` | 产品信息 | `backend/app/models.py` |
| `ProcessFlow` | 工艺流程 | `backend/app/models.py` |
| `SimulationScenario` | 异常模拟情境 | `backend/app/models.py` |

### 4.2 扩展模型

| 模型 | 变更内容 |
|------|----------|
| `Solution` | 新增成本矩阵字段 |
| `ProductionPlan` | 新增产品关联、进度字段 |
| `WorkOrder` | 新增执行关联字段 |

### 4.3 Solution模型扩展

```python
class SolutionExtended(SolutionBase, table=True):
    """解决方案（扩展）"""
    __tablename__ = "solutions"
    
    # ... 原有字段 ...
    
    # 成本矩阵（新增）
    repair_cost: float = Field(default=0)  # 维修成本
    delivery_impact_hours: float = Field(default=0)  # 交期影响小时数
    delivery_impact_cost: float = Field(default=0)  # 交期影响成本
    quality_risk_cost: float = Field(default=0)  # 品质风险成本
    downtime_cost: float = Field(default=0)  # 停产损失
    total_expected_loss: float = Field(default=0)  # 综合期望损失
    
    # 实施信息
    implementation_time_hours: float = Field(default=0)  # 实施时间
    required_resources: list[str] = Field(default=[], sa_column=Column(ARRAY(String)))  # 所需资源
```

---

## 5. API接口设计

### 5.1 异常处理相关

```python
# 获取异常详情（含根因）
GET /api/v1/anomalies/{id}
Response: {
    "id": "uuid",
    "line_id": "uuid",
    "station_id": "uuid",
    "defect_type": "string",
    "severity": "critical|error|warning",
    "root_cause_analysis": {
        "root_cause": "string",
        "confidence": 0.92,
        "causation_chain": [...]
    }
}

# 生成解决方案
POST /api/v1/anomalies/{id}/generate-solutions
Request: {
    "include_cost_analysis": true
}
Response: {
    "solutions": [
        {
            "id": "uuid",
            "title": "方案A：立即停机更换吸嘴",
            "is_recommended": true,
            "repair_cost": 2500,
            "delivery_impact_cost": 8000,
            "quality_risk_cost": 500,
            "downtime_cost": 12000,
            "total_expected_loss": 23000,
            "implementation_time_hours": 0.25,
            "success_rate": 0.92,
            "risk_level": "low"
        }
    ]
}

# 采纳方案并创建工单
POST /api/v1/solutions/{id}/adopt
Request: {
    "assigned_to": "user_id",
    "notes": "string"
}
Response: {
    "work_order_id": "uuid",
    "status": "pending",
    "redirect_url": "/app/zhixing?order_id=xxx"
}
```

### 5.2 生产计划相关

```python
# 获取当前生产计划
GET /api/v1/production/lines/{line_id}/current-plan
Response: {
    "current_plan": {
        "work_order_no": "WO-20260223-001",
        "product_id": "uuid",
        "product_code": "PCB-A",
        "product_name": "PCB-A型",
        "planned_quantity": 5000,
        "actual_quantity": 3250,
        "progress_percent": 65,
        "estimated_completion_time": "2026-02-23T18:00:00Z"
    },
    "next_plan": {
        "work_order_no": "WO-20260223-002",
        "product_code": "PCB-B",
        "product_name": "PCB-B型"
    },
    "product_change_warning": {
        "change_detected": true,
        "requires_optimization": true,
        "flow_differences": ["新增回流焊工序", "印刷参数变更"]
    }
}

# 触发产品切换优化
POST /api/v1/tianchou/product-switch-optimization
Request: {
    "line_id": "uuid",
    "current_product_id": "uuid",
    "next_product_id": "uuid",
    "current_layout": {...}
}
Response: {
    "task_id": "uuid",
    "redirect_url": "/app/tianchou?task_id=xxx"
}
```

### 5.3 异常模拟相关

```python
# 获取模拟情境列表
GET /api/v1/simulation/scenarios
Response: {
    "scenarios": [
        {
            "id": "uuid",
            "scenario_code": "SIM-001",
            "scenario_name": "锡焊不到位连续10个不良",
            "severity": "critical",
            "description": "..."
        }
    ]
}

# 执行模拟
POST /api/v1/simulation/execute
Request: {
    "scenario_id": "uuid"
}
Response: {
    "simulation_id": "uuid",
    "anomaly_data": {...},
    "root_cause": {...},
    "solutions": [...],
    "redirect_url": "/app/simulation?scenario_id=xxx"
}
```

---

## 6. 前端改造清单

### 6.1 页面变更

| 页面 | 变更内容 |
|------|----------|
| `Dashboard.tsx` | 新增生产计划模块、异常模拟入口 |
| `SinanAnalysis.tsx` | 重构方案展示，增加成本矩阵 |
| `KnowledgeGraph.tsx` | 新增"智能决策"按钮 |
| `Tianchou/index.tsx` | 支持产品切换优化模式 |

### 6.2 新增组件

| 组件 | 功能 |
|------|------|
| `ProductionPlanCard.tsx` | 生产计划卡片 |
| `ProductChangeAlert.tsx` | 产品切换预警弹窗 |
| `SolutionCostMatrix.tsx` | 方案成本矩阵展示 |
| `SimulationSelector.tsx` | 模拟情境选择器 |

### 6.3 状态管理

```typescript
// 新增全局状态
interface AppState {
  production: {
    currentPlan: ProductionPlan | null
    nextPlan: ProductionPlan | null
    productChangeWarning: ProductChangeWarning | null
  }
  simulation: {
    activeScenario: SimulationScenario | null
    isActive: boolean
  }
}
```

---

## 7. 后端改造清单

### 7.1 新增文件

| 文件 | 功能 |
|------|------|
| `backend/app/api/routes/simulation.py` | 异常模拟API |
| `backend/app/services/cost_calculator.py` | 成本计算服务 |
| `backend/app/services/product_flow.py` | 产品工艺流程服务 |

### 7.2 变更文件

| 文件 | 变更内容 |
|------|----------|
| `backend/app/models.py` | 新增模型、扩展Solution |
| `backend/app/api/routes/anomalies.py` | 新增方案生成接口 |
| `backend/app/api/routes/production.py` | 新增计划查询接口 |
| `backend/app/services/neo4j_service.py` | 增强根因分析 |

---

## 8. 验收标准

### 8.1 异常处理路线

**Dashboard → 格物**：
- [ ] Dashboard异常列表可点击，跳转到格物页面
- [ ] 跳转时携带异常ID参数

**格物页面**：
- [ ] 自动加载异常的知识图谱
- [ ] 可逐个点击原因节点查看详情
- [ ] "智能决策"按钮在格物页面显示
- [ ] 点击"智能决策"跳转司南页面

**司南页面**：
- [ ] 展示至少2个解决方案
- [ ] 每个方案显示完整成本矩阵（维修成本、交期影响、品质风险、停产损失、综合期望损失）
- [ ] 方案可按成本/时间/风险排序

**司南 → 智行**：
- [ ] 点击"采纳并执行"创建工单
- [ ] 自动跳转智行页面
- [ ] 智行页面展示执行进度、日志、操作按钮

### 8.2 优化路线

- [ ] Dashboard显示当前工单信息（5项必填字段）
- [ ] 产品切换时自动预警
- [ ] 点击"一键优化"跳转天筹并自动开始优化

### 8.3 异常模拟

- [ ] 至少10个预设模拟情境
- [ ] 情境选择器UI正常展示
- [ ] 模拟数据完整（根因+方案+成本）
- [ ] 模拟流程端到端可演示

### 8.4 数据完整性

- [ ] 数据库迁移脚本可正常执行
- [ ] 新增模型字段有默认值
- [ ] API返回数据结构符合规范

---

## 9. 里程碑

| 阶段 | 内容 | 交付物 |
|------|------|--------|
| Phase 1 | 数据模型 + API | 迁移脚本、API文档 |
| Phase 2 | 异常处理路线 | Dashboard+格物+司南改造 |
| Phase 3 | 优化路线 | 生产计划模块+天筹联动 |
| Phase 4 | 异常模拟 | 情境数据+模拟流程 |
| Phase 5 | 集成测试 | E2E测试报告 |

---

## 10. 风险与依赖


### 10.1 依赖项
- Neo4j知识图谱数据需完善（异常-原因-方案关联）
- 产品工艺流程数据需预先导入

---

*文档版本: v1.2 | 更新日期: 2026-02-24*
