# 3.2 ä¼˜åŒ–è·¯çº¿ - å‰ç«¯è®¾è®¡æ–‡æ¡£

> æ–‡æ¡£ç‰ˆæœ¬: v1.0 | åˆ›å»ºæ—¥æœŸ: 2026-02-24 | åŸºäºPRD: PRD-ç³»ç»Ÿé€»è¾‘ä¼˜åŒ–20260223.md

---

## 1. è®¾è®¡æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

å®ç°"ä¼˜åŒ–è·¯çº¿"ä¸šåŠ¡ä¸»çº¿çš„å‰ç«¯æ”¹é€ ï¼Œä½¿ç³»ç»Ÿå…·å¤‡ï¼š
- ç”Ÿäº§è®¡åˆ’å¯è§†åŒ–ç›‘æ§
- äº§å“åˆ‡æ¢é¢„è­¦ä¸ä¸€é”®ä¼˜åŒ–
- ä¸å¤©ç­¹ç³»ç»Ÿçš„æ— ç¼è”åŠ¨

### 1.2 è®¾è®¡åŸåˆ™

1. **è§†è§‰ä¸€è‡´æ€§**ï¼šé‡‡ç”¨ä¸ç°æœ‰Dashboardã€Tianchouç›¸åŒçš„UIé£æ ¼
   - ä¸»è‰²è°ƒï¼š`slate-50` èƒŒæ™¯ï¼Œ`white` å¡ç‰‡ï¼Œ`blue-600` ä¸»æŒ‰é’®
   - åœ†è§’ï¼š`rounded-xl` (12px)
   - é˜´å½±ï¼š`shadow-sm` / `shadow-md`
   - å­—ä½“ï¼š`Inter` / ç³»ç»Ÿsans-serif

2. **äº¤äº’æµç•…æ€§**ï¼šä¿æŒä¸ç°æœ‰ç³»ç»Ÿä¸€è‡´çš„äº¤äº’æ¨¡å¼
   - æŒ‰é’®hoveræ•ˆæœã€è¿‡æ¸¡åŠ¨ç”»
   - å¼¹çª—ä½¿ç”¨ç°æœ‰çš„Modalæ¨¡å¼
   - é¡µé¢è·³è½¬æºå¸¦å¿…è¦å‚æ•°

3. **æ¸è¿›å¢å¼º**ï¼šä¼˜å…ˆå®ç°æ ¸å¿ƒåŠŸèƒ½ï¼Œé€æ­¥å®Œå–„

---

## 2. é¡µé¢å¸ƒå±€è®¾è®¡

### 2.1 Dashboard æ–°å¢æ¨¡å—

åœ¨ç°æœ‰Dashboardé¡µé¢ä¸­æ–°å¢"ç”Ÿäº§è®¡åˆ’"æ¨¡å—ï¼Œä½ç½®åœ¨å®æ—¶äº§é‡ç›‘æ§å›¾è¡¨ä¸‹æ–¹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‹ ç”Ÿäº§è®¡åˆ’                                   [è¯¦æƒ…] [ä¼˜åŒ–]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å½“å‰å·¥å•: WO-20260223-001        äº§å“: PCB-Aå‹              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ è®¡åˆ’æ•°é‡: 5000    å®é™…æ•°é‡: 3250    è¿›åº¦: 65%              â”‚
â”‚ é¢„è®¡å®Œå•: 2026-02-23 18:00                                  â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€ ä¸‹ä¸€å·¥å•é¢„è§ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ WO-20260223-002  â”‚  äº§å“: PCB-Bå‹  â”‚  âš ï¸ äº§å“å˜åŒ–é¢„è­¦ â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ [ä¸€é”®ä¼˜åŒ–å¸ƒå±€] â† ä»…äº§å“åˆ‡æ¢æ—¶æ˜¾ç¤º                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç»„ä»¶å±‚çº§ç»“æ„

```
Dashboard (é¡µé¢)
â”œâ”€â”€ ProductionPlanCard (æ–°å¢ç»„ä»¶)
â”‚   â”œâ”€â”€ CurrentOrderInfo (å½“å‰å·¥å•ä¿¡æ¯)
â”‚   â”œâ”€â”€ ProgressBar (è¿›åº¦æ¡)
â”‚   â”œâ”€â”€ NextOrderPreview (ä¸‹ä¸€å·¥å•é¢„è§ˆ)
â”‚   â””â”€â”€ ProductChangeAlert (äº§å“åˆ‡æ¢é¢„è­¦å¼¹çª—)
â””â”€â”€ Tianchou Integration
    â””â”€â”€ ProductSwitchOptimization (å¤©ç­¹ä¼˜åŒ–å‚æ•°ä¼ é€’)
```

---

## 3. ç»„ä»¶è¯¦ç»†è®¾è®¡

### 3.1 ProductionPlanCard ç»„ä»¶

#### 3.1.1 ç»„ä»¶æ¥å£

```typescript
interface ProductionPlanCardProps {
  className?: string
  lineId: string
  onViewDetails?: () => void
  onOptimize?: (params: OptimizationParams) => void
}
```

#### 3.1.2 ç»„ä»¶ä»£ç 

```tsx
/**
 * ç”Ÿäº§è®¡åˆ’å¡ç‰‡ç»„ä»¶
 * ä½ç½®: frontend/components/ProductionPlanCard.tsx
 */

import { AlertTriangle, ArrowRight, ChevronRight, Clock, Package, Settings2 } from 'lucide-react'
import { useNavigate } from 'react-router-dom'
import type { ProductionPlan, ProductChangeWarning } from '../types'

interface ProductionPlanCardProps {
  className?: string
  currentPlan: ProductionPlan | null
  nextPlan: ProductionPlan | null
  productChangeWarning: ProductChangeWarning | null
  loading?: boolean
  onViewDetails?: () => void
  onOptimize?: (params: OptimizationParams) => void
}

interface OptimizationParams {
  mode: 'product_switch'
  current_product_id: string
  next_product_id: string
  current_layout: LayoutData
  process_flow: ProcessFlow
  line_id: string
}

interface LayoutData {
  devices: Array<{
    id: string
    name: string
    position: { x: number; y: number }
    type: string
  }>
  workshopDimensions: { length: number; width: number }
}

interface ProcessFlow {
  steps: Array<{
    step: number
    name: string
    station_type: string
    cycle_time: number
  }>
}

export const ProductionPlanCard: React.FC<ProductionPlanCardProps> = ({
  className = '',
  currentPlan,
  nextPlan,
  productChangeWarning,
  loading = false,
  onViewDetails,
  onOptimize,
}) => {
  const navigate = useNavigate()
  const hasProductChange = productChangeWarning?.change_detected ?? false

  // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
  const progressPercent = currentPlan
    ? Math.round((currentPlan.actual_quantity / currentPlan.planned_quantity) * 100)
    : 0

  // æ ¼å¼åŒ–é¢„è®¡å®Œå•æ—¶é—´
  const formatCompletionTime = (isoString: string | null) => {
    if (!isoString) return '--'
    const date = new Date(isoString)
    return date.toLocaleString('zh-CN', {
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
    })
  }

  // å¤„ç†ä¼˜åŒ–æŒ‰é’®ç‚¹å‡»
  const handleOptimize = () => {
    if (!currentPlan || !nextPlan || !onOptimize) return

    const params: OptimizationParams = {
      mode: 'product_switch',
      current_product_id: currentPlan.product_id,
      next_product_id: nextPlan.product_id,
      current_layout: {
        devices: [], // TODO: ä»å®é™…å¸ƒå±€æ•°æ®è·å–
        workshopDimensions: { length: 100, width: 60 },
      },
      process_flow: {
        steps: [], // TODO: ä»å·¥è‰ºæµç¨‹æ•°æ®è·å–
      },
      line_id: currentPlan.line_id,
    }

    onOptimize(params)
  }

  // å¤„ç†è¯¦æƒ…æŒ‰é’®ç‚¹å‡»
  const handleViewDetails = () => {
    if (onViewDetails) {
      onViewDetails()
    } else {
      // é»˜è®¤è·³è½¬åˆ°ç”Ÿäº§è®¡åˆ’è¯¦æƒ…é¡µ
      navigate('/app/production-plan')
    }
  }

  if (loading) {
    return (
      <div className={`bg-white rounded-xl border border-slate-100 shadow-sm p-6 ${className}`}>
        <div className="animate-pulse space-y-4">
          <div className="h-6 bg-slate-200 rounded w-1/3"></div>
          <div className="h-4 bg-slate-200 rounded w-2/3"></div>
          <div className="h-20 bg-slate-200 rounded"></div>
        </div>
      </div>
    )
  }

  if (!currentPlan) {
    return (
      <div className={`bg-white rounded-xl border border-slate-100 shadow-sm p-6 ${className}`}>
        <div className="flex items-center gap-3 mb-4">
          <div className="p-2 bg-blue-50 text-blue-600 rounded-lg">
            <Package size={20} />
          </div>
          <h3 className="font-bold text-slate-800 text-lg">ç”Ÿäº§è®¡åˆ’</h3>
        </div>
        <div className="text-center py-8 text-slate-500">
          <Package size={40} className="mx-auto mb-2 opacity-50" />
          <p>æš‚æ— ç”Ÿäº§è®¡åˆ’æ•°æ®</p>
        </div>
      </div>
    )
  }

  return (
    <div
      className={`bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden ${className}`}
    >
      {/* Header */}
      <div className="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-blue-50 text-blue-600 rounded-lg">
            <Package size={20} />
          </div>
          <h3 className="font-bold text-slate-800 text-lg">ç”Ÿäº§è®¡åˆ’</h3>
        </div>
        <div className="flex items-center gap-2">
          <button
            onClick={handleViewDetails}
            className="text-sm text-slate-500 hover:text-blue-600 font-medium flex items-center gap-1 px-3 py-1.5 rounded-lg hover:bg-slate-50 transition-colors"
          >
            è¯¦æƒ…
            <ChevronRight size={16} />
          </button>
        </div>
      </div>

      {/* Content */}
      <div className="p-6 space-y-5">
        {/* å½“å‰å·¥å•ä¿¡æ¯ */}
        <div className="space-y-3">
          <div className="flex items-center justify-between">
            <div>
              <span className="text-xs text-slate-500">å½“å‰å·¥å•</span>
              <p className="font-semibold text-slate-800 text-lg">{currentPlan.work_order_no}</p>
            </div>
            <div className="text-right">
              <span className="text-xs text-slate-500">äº§å“</span>
              <p className="font-semibold text-slate-800">
                {currentPlan.product_code} - {currentPlan.product_name}
              </p>
            </div>
          </div>

          <div className="h-px bg-slate-100" />

          {/* æ•°é‡ä¸è¿›åº¦ */}
          <div className="grid grid-cols-3 gap-4">
            <div>
              <p className="text-xs text-slate-500 mb-1">è®¡åˆ’æ•°é‡</p>
              <p className="font-semibold text-slate-700">{currentPlan.planned_quantity.toLocaleString()}</p>
            </div>
            <div>
              <p className="text-xs text-slate-500 mb-1">å®é™…æ•°é‡</p>
              <p className="font-semibold text-slate-700">{currentPlan.actual_quantity.toLocaleString()}</p>
            </div>
            <div>
              <p className="text-xs text-slate-500 mb-1">é¢„è®¡å®Œå•</p>
              <p className="font-semibold text-slate-700 flex items-center gap-1">
                <Clock size={14} className="text-slate-400" />
                {formatCompletionTime(currentPlan.estimated_completion_time)}
              </p>
            </div>
          </div>

          {/* è¿›åº¦æ¡ */}
          <div className="space-y-1.5">
            <div className="flex justify-between text-sm">
              <span className="text-slate-500">å®Œæˆè¿›åº¦</span>
              <span className="font-semibold text-blue-600">{progressPercent}%</span>
            </div>
            <div className="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
              <div
                className={`h-full rounded-full transition-all duration-500 ${
                  progressPercent >= 100
                    ? 'bg-green-500'
                    : progressPercent >= 70
                      ? 'bg-blue-500'
                      : progressPercent >= 50
                        ? 'bg-amber-500'
                        : 'bg-red-500'
                }`}
                style={{ width: `${Math.min(progressPercent, 100)}%` }}
              />
            </div>
          </div>
        </div>

        {/* ä¸‹ä¸€å·¥å•é¢„è§ˆ */}
        {nextPlan && (
          <div className="space-y-3">
            <div className="h-px bg-slate-100" />

            <div className="bg-slate-50 rounded-lg p-4 space-y-2">
              <div className="flex items-center justify-between">
                <span className="text-xs font-medium text-slate-500 uppercase tracking-wide">
                  ä¸‹ä¸€å·¥å•é¢„è§ˆ
                </span>
                {hasProductChange && (
                  <span className="flex items-center gap-1 text-xs font-medium text-amber-600 bg-amber-50 px-2 py-0.5 rounded-full">
                    <AlertTriangle size={12} />
                    äº§å“å˜åŒ–é¢„è­¦
                  </span>
                )}
              </div>

              <div className="flex items-center justify-between">
                <div>
                  <p className="font-semibold text-slate-700">{nextPlan.work_order_no}</p>
                  <p className="text-sm text-slate-500">
                    äº§å“: {nextPlan.product_code} - {nextPlan.product_name}
                  </p>
                </div>
                <ArrowRight size={20} className="text-slate-300" />
              </div>

              {/* å·¥è‰ºæµç¨‹å·®å¼‚æç¤º */}
              {hasProductChange && productChangeWarning?.flow_differences && (
                <div className="mt-2 p-2 bg-amber-50 border border-amber-100 rounded text-xs text-amber-700">
                  <p className="font-medium mb-1">å·¥è‰ºå˜åŒ–:</p>
                  <ul className="list-disc list-inside space-y-0.5">
                    {productChangeWarning.flow_differences.slice(0, 3).map((diff, idx) => (
                      <li key={idx}>{diff}</li>
                    ))}
                    {productChangeWarning.flow_differences.length > 3 && (
                      <li className="text-amber-500">
                        ...è¿˜æœ‰ {productChangeWarning.flow_differences.length - 3} é¡¹å˜åŒ–
                      </li>
                    )}
                  </ul>
                </div>
              )}
            </div>

            {/* ä¸€é”®ä¼˜åŒ–æŒ‰é’® - ä»…äº§å“åˆ‡æ¢æ—¶æ˜¾ç¤º */}
            {hasProductChange && (
              <button
                onClick={handleOptimize}
                className="w-full py-3 bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-lg font-medium flex items-center justify-center gap-2 hover:from-blue-700 hover:to-blue-600 transition-all shadow-md shadow-blue-200"
              >
                <Settings2 size={18} />
                ä¸€é”®ä¼˜åŒ–å¸ƒå±€
              </button>
            )}
          </div>
        )}
      </div>
    </div>
  )
}

export default ProductionPlanCard
```

---

### 3.2 ProductChangeAlert ç»„ä»¶

#### 3.2.1 ç»„ä»¶æ¥å£

```typescript
interface ProductChangeAlertProps {
  visible: boolean
  currentProduct: string
  nextProduct: string
  differences: string[]
  onOptimize?: () => void
  onDismiss?: () => void
}
```

#### 3.2.2 ç»„ä»¶ä»£ç 

```tsx
/**
 * äº§å“åˆ‡æ¢é¢„è­¦å¼¹çª—ç»„ä»¶
 * ä½ç½®: frontend/components/ProductChangeAlert.tsx
 */

import { AlertTriangle, ArrowRight, Settings2, X } from 'lucide-react'

interface ProductChangeAlertProps {
  visible: boolean
  currentProduct: string
  nextProduct: string
  differences: string[]
  onOptimize?: () => void
  onDismiss?: () => void
}

export const ProductChangeAlert: React.FC<ProductChangeAlertProps> = ({
  visible,
  currentProduct,
  nextProduct,
  differences = [],
  onOptimize,
  onDismiss,
}) => {
  if (!visible) return null

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      {/* Backdrop */}
      <div className="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onClick={onDismiss} />

      {/* Modal */}
      <div className="relative bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden animate-in fade-in zoom-in-95 duration-200">
        {/* Header */}
        <div className="bg-gradient-to-r from-amber-500 to-orange-400 px-6 py-4 flex items-center justify-between">
          <div className="flex items-center gap-3 text-white">
            <div className="p-2 bg-white/20 rounded-lg">
              <AlertTriangle size={24} />
            </div>
            <div>
              <h3 className="font-bold text-lg">äº§å“åˆ‡æ¢é¢„è­¦</h3>
              <p className="text-white/80 text-sm">æ£€æµ‹åˆ°å³å°†å‘ç”Ÿäº§å“åˆ‡æ¢</p>
            </div>
          </div>
          <button
            onClick={onDismiss}
            className="p-1.5 hover:bg-white/20 rounded-lg text-white/80 hover:text-white transition-colors"
          >
            <X size={20} />
          </button>
        </div>

        {/* Content */}
        <div className="p-6 space-y-4">
          {/* äº§å“åˆ‡æ¢å¯¹æ¯” */}
          <div className="flex items-center justify-between p-4 bg-slate-50 rounded-xl">
            <div className="text-center flex-1">
              <p className="text-xs text-slate-500 mb-1">å½“å‰äº§å“</p>
              <p className="font-semibold text-slate-800">{currentProduct}</p>
            </div>
            <div className="px-4">
              <ArrowRight size={24} className="text-slate-300" />
            </div>
            <div className="text-center flex-1">
              <p className="text-xs text-slate-500 mb-1">ä¸‹ä¸€äº§å“</p>
              <p className="font-semibold text-blue-600">{nextProduct}</p>
            </div>
          </div>

          {/* å·¥è‰ºå·®å¼‚ */}
          {differences.length > 0 && (
            <div className="space-y-2">
              <p className="text-sm font-medium text-slate-700">å·¥è‰ºæµç¨‹å·®å¼‚:</p>
              <div className="bg-amber-50 border border-amber-100 rounded-lg p-3 max-h-32 overflow-y-auto">
                <ul className="space-y-1">
                  {differences.map((diff, idx) => (
                    <li key={idx} className="text-sm text-amber-700 flex items-start gap-2">
                      <span className="text-amber-400 mt-0.5">â€¢</span>
                      {diff}
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          )}

          {/* å»ºè®® */}
          <div className="p-3 bg-blue-50 rounded-lg">
            <p className="text-sm text-blue-700">
              å»ºè®®åœ¨åˆ‡æ¢å‰è¿›è¡Œå¸ƒå±€ä¼˜åŒ–ï¼Œä»¥å‡å°‘æ¢çº¿æ—¶é—´å¹¶æå‡ç”Ÿäº§æ•ˆç‡ã€‚
            </p>
          </div>
        </div>

        {/* Footer */}
        <div className="px-6 py-4 bg-slate-50 flex gap-3">
          <button
            onClick={onDismiss}
            className="flex-1 py-2.5 px-4 bg-white border border-slate-200 text-slate-700 rounded-lg font-medium hover:bg-slate-50 transition-colors"
          >
            æš‚ä¸ä¼˜åŒ–
          </button>
          <button
            onClick={onOptimize}
            className="flex-1 py-2.5 px-4 bg-blue-600 text-white rounded-lg font-medium flex items-center justify-center gap-2 hover:bg-blue-700 transition-colors shadow-md shadow-blue-200"
          >
            <Settings2 size={18} />
            ç«‹å³ä¼˜åŒ–
          </button>
        </div>
      </div>
    </div>
  )
}

export default ProductChangeAlert
```

---

### 3.3 Dashboard é›†æˆ

åœ¨ç°æœ‰Dashboardé¡µé¢ä¸­é›†æˆç”Ÿäº§è®¡åˆ’æ¨¡å—ï¼š

```tsx
// ä¿®æ”¹ frontend/pages/Dashboard.tsx

// 1. å¯¼å…¥æ–°ç»„ä»¶
import ProductionPlanCard from '../components/ProductionPlanCard'
import ProductChangeAlert from '../components/ProductChangeAlert'

// 2. æ·»åŠ çŠ¶æ€ç®¡ç†
const [productionPlan, setProductionPlan] = useState<{
  currentPlan: ProductionPlan | null
  nextPlan: ProductionPlan | null
  productChangeWarning: ProductChangeWarning | null
}>({
  currentPlan: null,
  nextPlan: null,
  productChangeWarning: null,
})

const [showProductAlert, setShowProductAlert] = useState(false)

// 3. åŠ è½½ç”Ÿäº§è®¡åˆ’æ•°æ®
useEffect(() => {
  // TODO: æ›¿æ¢ä¸ºå®é™…APIè°ƒç”¨
  // const fetchProductionPlan = async () => {
  //   const response = await api.getProductionPlan(selectedLine?.id)
  //   setProductionPlan(response.data)
  //   if (response.data.productChangeWarning?.change_detected) {
  //     setShowProductAlert(true)
  //   }
  // }
  // fetchProductionPlan()
  
  // Mockæ•°æ®
  setProductionPlan({
    currentPlan: {
      work_order_no: 'WO-20260224-001',
      product_id: 'p-001',
      product_code: 'PCB-A',
      product_name: 'PCB-Aå‹',
      line_id: selectedLine?.id || '',
      planned_quantity: 5000,
      actual_quantity: 3250,
      estimated_completion_time: new Date().toISOString(),
    },
    nextPlan: {
      work_order_no: 'WO-20260224-002',
      product_id: 'p-002',
      product_code: 'PCB-B',
      product_name: 'PCB-Bå‹',
      line_id: selectedLine?.id || '',
      planned_quantity: 3000,
      actual_quantity: 0,
      estimated_completion_time: null,
    },
    productChangeWarning: {
      change_detected: true,
      current_product: 'PCB-A',
      next_product: 'PCB-B',
      requires_optimization: true,
      flow_differences: [
        'æ–°å¢å›æµç„Šå·¥åº',
        'å°åˆ·å‚æ•°å˜æ›´',
        'æ£€æµ‹è®¾å¤‡å¢åŠ ',
      ],
    },
  })
}, [selectedLine])

// 4. ä¼˜åŒ–æŒ‰é’®å¤„ç†
const handleOptimize = (params: OptimizationParams) => {
  // è·³è½¬åˆ°å¤©ç­¹é¡µé¢ï¼Œæºå¸¦äº§å“åˆ‡æ¢ä¼˜åŒ–å‚æ•°
  navigate('/app/tianchou', {
    state: {
      optimizationMode: 'product_switch',
      ...params,
    },
  })
}

// 5. åœ¨Dashboardå¸ƒå±€ä¸­æ–°å¢ç”Ÿäº§è®¡åˆ’æ¨¡å—
{
  /* ç”Ÿäº§è®¡åˆ’æ¨¡å— - æ”¾åœ¨å®æ—¶äº§é‡ç›‘æ§ä¸‹æ–¹ */
}
<ProductionPlanCard
  currentPlan={productionPlan.currentPlan}
  nextPlan={productionPlan.nextPlan}
  productChangeWarning={productionPlan.productChangeWarning}
  onOptimize={handleOptimize}
/>

// 6. äº§å“åˆ‡æ¢é¢„è­¦å¼¹çª—
<ProductChangeAlert
  visible={showProductAlert}
  currentProduct={productionPlan.productChangeWarning?.current_product || ''}
  nextProduct={productionPlan.productChangeWarning?.next_product || ''}
  differences={productionPlan.productChangeWarning?.flow_differences || []}
  onOptimize={() => {
    setShowProductAlert(false)
    handleOptimize({
      mode: 'product_switch',
      current_product_id: productionPlan.currentPlan?.product_id || '',
      next_product_id: productionPlan.nextPlan?.product_id || '',
      current_layout: { devices: [], workshopDimensions: { length: 100, width: 60 } },
      process_flow: { steps: [] },
      line_id: selectedLine?.id || '',
    })
  }}
  onDismiss={() => setShowProductAlert(false)}
/>
```

---

## 4. å¤©ç­¹é›†æˆè®¾è®¡

### 4.1 å‚æ•°ä¼ é€’æœºåˆ¶

äº§å“åˆ‡æ¢ä¼˜åŒ–æ—¶ï¼Œéœ€è¦å°†ä»¥ä¸‹å‚æ•°ä¼ é€’ç»™å¤©ç­¹é¡µé¢ï¼š

```typescript
// å¤©ç­¹æ¥æ”¶å‚æ•°ç±»å‹
interface ProductSwitchParams {
  // æ¨¡å¼æ ‡è¯†
  mode: 'product_switch'  // åŒºåˆ«äºæ™®é€šmanualæ¨¡å¼
  
  // äº§å“ä¿¡æ¯
  current_product_id: string
  next_product_id: string
  current_product_code: string
  next_product_code: string
  
  // äº§çº¿ä¿¡æ¯
  line_id: string
  
  // å¸ƒå±€æ•°æ® (ä»ç°æœ‰å¸ƒå±€è·å–)
  current_layout: {
    devices: Array<{
      id: string
      name: string
      position: { x: number; y: number }
      type: string
    }>
    workshopDimensions: { length: number; width: number }
  }
  
  // å·¥è‰ºæµç¨‹æ•°æ® (ä»Product/ProcessFlowè¡¨è·å–)
  process_flows: {
    current: {
      steps: Array<{
        step: number
        name: string
        station_type: string
        cycle_time: number
      }>
    }
    next: {
      steps: Array<{
        step: number
        name: string
        station_type: string
        cycle_time: number
      }>
    }
  }
}
```

### 4.2 å¤©ç­¹é¡µé¢é€‚é…

åœ¨å¤©ç­¹é¡µé¢æ£€æµ‹å¹¶å¤„ç†äº§å“åˆ‡æ¢æ¨¡å¼ï¼š

```tsx
// åœ¨ Tianchou/index.tsx ä¸­æ·»åŠ 

import { useLocation } from 'react-router-dom'

// æ£€æµ‹è·¯ç”±å‚æ•°
const location = useLocation()
const optimizationMode = location.state?.optimizationMode

// å¦‚æœæ˜¯äº§å“åˆ‡æ¢æ¨¡å¼ï¼Œè‡ªåŠ¨å¡«å……å‚æ•°å¹¶å¼€å§‹ä¼˜åŒ–
useEffect(() => {
  if (optimizationMode === 'product_switch') {
    const params = location.state as ProductSwitchParams
    
    // è®¾ç½®ä»»åŠ¡é…ç½®
    setTaskConfig({
      industryType: 'light', // æˆ–æ ¹æ®å·¥è‰ºæµç¨‹åˆ¤æ–­
      taskName: `äº§å“åˆ‡æ¢ä¼˜åŒ–: ${params.current_product_code} â†’ ${params.next_product_code}`,
      // è‡ªåŠ¨å¡«å……å‚æ•°
      currentProduct: params.current_product_code,
      nextProduct: params.next_product_code,
      // ä»å·¥è‰ºæµç¨‹æå–è®¾å¤‡éœ€æ±‚
      deviceRequirements: params.process_flows.next.steps.map(s => s.station_type),
    })
    
    // è‡ªåŠ¨å¼€å§‹ä¼˜åŒ–
    handleCreateTask({
      industry_type: 'light',
      name: params.current_product_code + 'â†’' + params.next_product_code + 'åˆ‡æ¢ä¼˜åŒ–',
      workshop_length: params.current_layout.workshopDimensions.length,
      workshop_width: params.current_layout.workshopDimensions.width,
      device_count: params.current_layout.devices.length,
      // å…¶ä»–å¿…è¦å‚æ•°...
    })
  }
}, [optimizationMode])
```

---

## 5. API æ¥å£è®¾è®¡

### 5.1 ç”Ÿäº§è®¡åˆ’ API

```typescript
// GET /api/v1/production/lines/:lineId/current-plan
// è·å–å½“å‰äº§çº¿çš„ç”Ÿäº§è®¡åˆ’

interface ProductionPlanResponse {
  current_plan: {
    work_order_no: string
    product_id: string
    product_code: string
    product_name: string
    line_id: string
    planned_quantity: number
    actual_quantity: number
    progress_percent: number
    estimated_completion_time: string | null
    status: 'running' | 'paused' | 'completed'
  } | null
  
  next_plan: {
    work_order_no: string
    product_id: string
    product_code: string
    product_name: string
    planned_quantity: number
    estimated_start_time: string | null
  } | null
  
  product_change_warning: {
    change_detected: boolean
    current_product: string
    next_product: string
    requires_optimization: boolean
    flow_differences: string[]
  } | null
}
```

### 5.2 äº§å“åˆ‡æ¢ä¼˜åŒ– API

```typescript
// POST /api/v1/tianchou/product-switch-optimization
// è§¦å‘äº§å“åˆ‡æ¢ä¼˜åŒ–

interface ProductSwitchOptimizationRequest {
  line_id: string
  current_product_id: string
  next_product_id: string
  current_layout: {
    devices: Array<{
      id: string
      name: string
      position: { x: number; y: number }
      type: string
    }>
  }
  process_flow_current: {
    steps: Array<{
      step: number
      name: string
      station_type: string
    }>
  }
  process_flow_next: {
    steps: Array<{
      step: number
      name: string
      station_type: string
    }>
  }
}

interface ProductSwitchOptimizationResponse {
  task_id: string
  status: 'pending' | 'running' | 'completed'
  estimated_time: number  // é¢„è®¡è€—æ—¶(ç§’)
  redirect_url: string
}
```

---

## 6. æ•°æ®æ¨¡å‹æ‰©å±•

### 6.1 å‰ç«¯ç±»å‹æ‰©å±•

åœ¨ `frontend/types.ts` ä¸­æ–°å¢ï¼š

```typescript
// ç”Ÿäº§è®¡åˆ’
export interface ProductionPlan {
  work_order_no: string
  product_id: string
  product_code: string
  product_name: string
  line_id: string
  planned_quantity: number
  actual_quantity: number
  progress_percent: number
  estimated_completion_time: string | null
  status: 'running' | 'paused' | 'completed'
}

export interface NextPlan {
  work_order_no: string
  product_id: string
  product_code: string
  product_name: string
  planned_quantity: number
  estimated_start_time: string | null
}

export interface ProductChangeWarning {
  change_detected: boolean
  current_product: string
  next_product: string
  requires_optimization: boolean
  flow_differences: string[]
}

// äº§å“ä¿¡æ¯
export interface Product {
  id: string
  product_code: string
  product_name: string
  category: string | null
  default_flow_id: string | null
  dimensions: { length: number; width: number; height: number } | null
  required_stations: string[]
}

// å·¥è‰ºæµç¨‹
export interface ProcessFlow {
  id: string
  product_id: string
  flow_name: string
  version: string
  steps: Array<{
    step: number
    name: string
    station_type: string
    cycle_time: number
  }>
  equipment_requirements: Record<string, any>
}
```

---

## 7. å®ç°è®¡åˆ’

### Phase 1: æ•°æ®æ¨¡å‹ä¸API (ä¼˜å…ˆçº§: é«˜)
- [ ] åç«¯æ–°å¢ Product, ProcessFlow æ¨¡å‹
- [ ] åç«¯æ–°å¢ç”Ÿäº§è®¡åˆ’API
- [ ] æ•°æ®åº“è¿ç§»è„šæœ¬

### Phase 2: Dashboardç”Ÿäº§è®¡åˆ’æ¨¡å— (ä¼˜å…ˆçº§: é«˜)
- [ ] åˆ›å»º ProductionPlanCard ç»„ä»¶
- [ ] åˆ›å»º ProductChangeAlert ç»„ä»¶
- [ ] é›†æˆåˆ° Dashboard é¡µé¢

### Phase 3: å¤©ç­¹é›†æˆ (ä¼˜å…ˆçº§: é«˜)
- [ ] å¤©ç­¹é¡µé¢é€‚é…äº§å“åˆ‡æ¢æ¨¡å¼
- [ ] å‚æ•°ä¼ é€’ä¸è‡ªåŠ¨å¡«å……
- [ ] ä¼˜åŒ–ç»“æœå±•ç¤º

### Phase 4: ä¼˜åŒ–ä¸æµ‹è¯• (ä¼˜å…ˆçº§: ä¸­)
- [ ] å•å…ƒæµ‹è¯•
- [ ] E2Eæµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–

---

## 8. éªŒæ”¶æ ‡å‡†

- [ ] Dashboardæ˜¾ç¤ºå½“å‰å·¥å•ä¿¡æ¯ï¼ˆå·¥å•å·ã€äº§å“ç¼–å·ã€è®¡åˆ’/å®é™…æ•°é‡ã€è¿›åº¦ã€é¢„è®¡å®Œå•æ—¶é—´ï¼‰
- [ ] Dashboardæ˜¾ç¤ºä¸‹ä¸€å·¥å•é¢„è§ˆ
- [ ] äº§å“åˆ‡æ¢æ—¶æ˜¾ç¤ºé¢„è­¦å¼¹çª—
- [ ] ç‚¹å‡»"ä¸€é”®ä¼˜åŒ–"è·³è½¬å¤©ç­¹å¹¶è‡ªåŠ¨å¼€å§‹ä¼˜åŒ–
- [ ] å¤©ç­¹é¡µé¢æ­£ç¡®æ¥æ”¶å¹¶å±•ç¤ºäº§å“åˆ‡æ¢ä¼˜åŒ–ç»“æœ
- [ ] UIæ ·å¼ä¸ç°æœ‰ç³»ç»Ÿä¿æŒä¸€è‡´

---

## 9. å‚è€ƒèµ„æº

- ç°æœ‰Dashboardé¡µé¢: `frontend/pages/Dashboard.tsx`
- ç°æœ‰å¤©ç­¹é¡µé¢: `frontend/pages/Tianchou/index.tsx`
- ç°æœ‰ç»„ä»¶æ ·å¼: `frontend/components/AnomalyList.tsx`
- PRDåŸæ–‡: `docs/ç³»ç»Ÿä¼˜åŒ–/PRD-ç³»ç»Ÿé€»è¾‘ä¼˜åŒ–20260223.md`

---

*æ–‡æ¡£ç»“æŸ*
