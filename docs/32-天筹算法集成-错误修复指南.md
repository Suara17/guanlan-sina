# å¤©ç­¹ç®—æ³•é›†æˆ - é”™è¯¯ä¿®å¤æŒ‡å—

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åˆ›å»ºæ—¥æœŸ**: 2026-02-12
**æœ€åæ›´æ–°**: 2026-02-12

---

## ç›®å½•

1. [é—®é¢˜æ¦‚è¿°](#é—®é¢˜æ¦‚è¿°)
2. [é”™è¯¯ç°è±¡](#é”™è¯¯ç°è±¡)
3. [æ ¹æœ¬åŸå› ](#æ ¹æœ¬åŸå› )
4. [ä¿®å¤æ–¹æ¡ˆ](#ä¿®å¤æ–¹æ¡ˆ)
5. [Dockerç›¸å…³é¿é›·æŒ‡å—](#dockerç›¸å…³é¿é›·æŒ‡å—)
6. [éªŒè¯æ­¥éª¤](#éªŒè¯æ­¥éª¤)
7. [ç»éªŒæ•™è®­](#ç»éªŒæ•™è®­)

---

## é—®é¢˜æ¦‚è¿°

### é—®é¢˜æè¿°
å¤©ç­¹ä¼˜åŒ–ä»»åŠ¡åˆ›å»ºåç«‹å³å¤±è´¥ï¼ŒçŠ¶æ€ä» `pending` â†’ `running` â†’ `failed`ï¼Œæ— æ³•ç”Ÿæˆå¸•ç´¯æ‰˜æœ€ä¼˜è§£ã€‚

### å½±å“èŒƒå›´
- è½»å·¥ä¸šä¼˜åŒ–åŠŸèƒ½å®Œå…¨ä¸å¯ç”¨
- é‡å·¥ä¸šä¼˜åŒ–åŠŸèƒ½å¯èƒ½å­˜åœ¨ç±»ä¼¼é—®é¢˜
- å‰ç«¯æ— æ³•è·å–ä¼˜åŒ–ç»“æœ

### ä¸¥é‡ç¨‹åº¦
ğŸ”´ **Critical** - æ ¸å¿ƒåŠŸèƒ½å®Œå…¨å¤±æ•ˆ

---

## é”™è¯¯ç°è±¡

### 1. APIå“åº”
```json
{
  "task_id": "xxx",
  "status": "failed",
  "progress": 0
}
```

### 2. åç«¯æ—¥å¿—é”™è¯¯
```python
File "/app/app/algorithms/part1_optimization.py", line 402, in evaluate_individual
    used_area += self.device_sizes[i, 0] * self.device_sizes[i, 1]
TypeError: list indices must be integers or slices, not tuple
```

### 3. é”™è¯¯å †æ ˆ
```
run_optimization_task()
  â†’ dual_track.run_light_industry_optimization()
    â†’ optimizer.run_optimization()
      â†’ evaluate_individual()
        â†’ self.device_sizes[i, 0]  # âŒ TypeError
```

---

## æ ¹æœ¬åŸå› 

### æ•°æ®ç±»å‹ä¸åŒ¹é…

**é—®é¢˜ä»£ç ** (`backend/app/api/routes/tianchou.py:153-156`):
```python
# âŒ é”™è¯¯ï¼šä¼ é€’ Python list
input_data = {
    'device_sizes': api_params.get('device_sizes', [[3.0, 2.0]] * device_count),
    'original_positions': api_params.get('original_positions', [[i * 3, 10] for i in range(device_count)]),
    'move_costs': api_params.get('move_costs', [100.0] * device_count),
    'safety_distances': api_params.get('safety_distances', [1.0] * device_count),
}
```

**ç®—æ³•æœŸæœ›** (`backend/app/algorithms/part1_optimization.py:402`):
```python
# ç®—æ³•ä»£ç ä½¿ç”¨ numpy å¤šç»´ç´¢å¼•
used_area += self.device_sizes[i, 0] * self.device_sizes[i, 1]
#                              ^^^^^ éœ€è¦ numpy æ•°ç»„æ‰èƒ½ä½¿ç”¨ [i, 0] ç´¢å¼•
```

### ä¸ºä»€ä¹ˆä¼šå‡ºé”™ï¼Ÿ

| æ•°æ®ç±»å‹ | ç´¢å¼•æ–¹å¼ | ç»“æœ |
|---------|---------|------|
| Python list | `list[i][0]` | âœ… æ­£å¸¸ |
| Python list | `list[i, 0]` | âŒ TypeError |
| Numpy array | `array[i][0]` | âœ… æ­£å¸¸ |
| Numpy array | `array[i, 0]` | âœ… æ­£å¸¸ |

---

## ä¿®å¤æ–¹æ¡ˆ

### ä»£ç ä¿®å¤

**æ–‡ä»¶**: `backend/app/api/routes/tianchou.py`
**ä½ç½®**: ç¬¬153-156è¡Œ

```python
# âœ… æ­£ç¡®ï¼šè½¬æ¢ä¸º numpy æ•°ç»„
input_data = {
    'device_sizes': np.array(
        api_params.get('device_sizes', [[3.0, 2.0]] * device_count),
        dtype=np.float64
    ),
    'original_positions': np.array(
        api_params.get('original_positions', [[i * 3, 10] for i in range(device_count)]),
        dtype=np.float64
    ),
    'move_costs': np.array(
        api_params.get('move_costs', [100.0] * device_count),
        dtype=np.float64
    ),
    'safety_distances': np.array(
        api_params.get('safety_distances', [1.0] * device_count),
        dtype=np.float64
    ),
}
```

### ä¿®å¤è¦ç‚¹

1. **ä½¿ç”¨ `np.array()` åŒ…è£…**ï¼šå°† Python list è½¬æ¢ä¸º numpy æ•°ç»„
2. **æŒ‡å®š `dtype=np.float64`**ï¼šç¡®ä¿æ•°æ®ç±»å‹ä¸€è‡´ï¼Œé¿å…ç²¾åº¦é—®é¢˜
3. **ä¿æŒé»˜è®¤å€¼é€»è¾‘**ï¼šä¸æ”¹å˜ API å‚æ•°çš„é»˜è®¤å€¼ç”Ÿæˆé€»è¾‘

---

## Dockerç›¸å…³é¿é›·æŒ‡å—

### âš ï¸ å¸¸è§é™·é˜±

#### 1. ä»£ç ä¿®æ”¹æœªç”Ÿæ•ˆ

**ç°è±¡**ï¼š
- æœ¬åœ°æ–‡ä»¶å·²ä¿®æ”¹
- å®¹å™¨å†…ä»£ç ä»æ˜¯æ—§ç‰ˆæœ¬
- é‡å¯å®¹å™¨æ— æ•ˆ

**åŸå› **ï¼š
Docker é•œåƒåœ¨æ„å»ºæ—¶å°†ä»£ç å¤åˆ¶åˆ°é•œåƒä¸­ï¼Œå®¹å™¨è¿è¡Œçš„æ˜¯é•œåƒå†…çš„ä»£ç å‰¯æœ¬ï¼Œä¸æ˜¯ä¸»æœºä»£ç ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

##### æ–¹æ¡ˆAï¼šé‡æ–°æ„å»ºé•œåƒï¼ˆæ¨èï¼‰
```bash
cd E:\Guanlan-Sina

# 1. åœæ­¢å®¹å™¨
docker compose stop backend

# 2. åˆ é™¤æ—§é•œåƒ
docker rmi guanlan-sina-backend:latest

# 3. æ¸…é™¤æ„å»ºç¼“å­˜ï¼ˆå¯é€‰ï¼‰
docker builder prune -f

# 4. é‡æ–°æ„å»º
docker compose build backend

# 5. å¯åŠ¨å®¹å™¨
docker compose up -d backend
```

##### æ–¹æ¡ˆBï¼šä½¿ç”¨ docker cpï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰
```bash
# å°†ä¿®æ”¹åçš„æ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨
docker cp "E:/Guanlan-Sina/backend/app/api/routes/tianchou.py" \
  guanlan-sina-backend-1:/app/app/api/routes/tianchou.py

# é‡å¯å®¹å™¨
docker restart guanlan-sina-backend-1
```

âš ï¸ **æ³¨æ„**ï¼šæ–¹æ¡ˆBåªæ˜¯ä¸´æ—¶ä¿®å¤ï¼Œå®¹å™¨é‡å»ºåä¼šä¸¢å¤±ã€‚

##### æ–¹æ¡ˆCï¼šä½¿ç”¨ Volume æŒ‚è½½ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
åœ¨ `docker-compose.override.yml` ä¸­é…ç½®ï¼š
```yaml
services:
  backend:
    develop:
      watch:
        - path: ./backend
          action: sync
          target: /app
          ignore:
            - ./backend/.venv
```

#### 2. æ„å»ºç¼“å­˜é—®é¢˜

**ç°è±¡**ï¼š
```
#10 [stage-0 7/9] COPY ./app /app/app
#10 CACHED  # âš ï¸ ä½¿ç”¨äº†ç¼“å­˜ï¼Œæ²¡æœ‰å¤åˆ¶æ–°ä»£ç 
```

**åŸå› **ï¼š
Docker ä½¿ç”¨å±‚ç¼“å­˜ä¼˜åŒ–æ„å»ºé€Ÿåº¦ï¼Œä½†å¯èƒ½å¯¼è‡´ä»£ç æ›´æ–°æœªè¢«æ£€æµ‹åˆ°ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# æ–¹æ³•1ï¼šæ¸…é™¤æ‰€æœ‰æ„å»ºç¼“å­˜
docker builder prune -f

# æ–¹æ³•2ï¼šä½¿ç”¨ --no-cache æ„å»º
docker compose build --no-cache backend

# æ–¹æ³•3ï¼šä¿®æ”¹æ–‡ä»¶æ—¶é—´æˆ³å¼ºåˆ¶é‡æ–°å¤åˆ¶
touch backend/app/api/routes/tianchou.py
```

#### 3. ç½‘ç»œé—®é¢˜å¯¼è‡´æ„å»ºå¤±è´¥

**ç°è±¡**ï¼š
```
error: Failed to fetch: `https://pypi.org/simple/websockets/`
  Caused by: peer closed connection without sending TLS close_notify
```

**åŸå› **ï¼š
- ç½‘ç»œä¸ç¨³å®š
- PyPI é•œåƒæºé—®é¢˜
- Docker æ„å»ºæ—¶çš„ç½‘ç»œé™åˆ¶

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# æ–¹æ³•1ï¼šé‡è¯•æ„å»ºï¼ˆé€šå¸¸èƒ½è§£å†³ï¼‰
docker compose build backend

# æ–¹æ³•2ï¼šä½¿ç”¨å›½å†…é•œåƒæº
# åœ¨ backend/Dockerfile ä¸­æ·»åŠ ï¼š
ENV UV_INDEX_URL=https://pypi.tuna.tsinghua.edu.cn/simple

# æ–¹æ³•3ï¼šä½¿ç”¨å·²æœ‰é•œåƒ + docker cp
# è§"æ–¹æ¡ˆBï¼šä½¿ç”¨ docker cp"
```

#### 4. å®¹å™¨å†…ä¿®æ”¹éªŒè¯

**æ£€æŸ¥å®¹å™¨å†…ä»£ç æ˜¯å¦å·²æ›´æ–°**ï¼š
```bash
# æŸ¥çœ‹ç‰¹å®šä»£ç è¡Œ
docker exec guanlan-sina-backend-1 sh -c \
  "grep -A 3 'device_sizes' /app/app/api/routes/tianchou.py | head -5"

# æŸ¥çœ‹æ–‡ä»¶ä¿®æ”¹æ—¶é—´
docker exec guanlan-sina-backend-1 ls -lh /app/app/api/routes/tianchou.py

# è¿›å…¥å®¹å™¨æŸ¥çœ‹
docker exec -it guanlan-sina-backend-1 sh
cat /app/app/api/routes/tianchou.py
```

---

## éªŒè¯æ­¥éª¤

### 1. éªŒè¯ä»£ç ä¿®å¤

```bash
# æ£€æŸ¥ä¸»æœºä»£ç 
grep -A 3 "device_sizes" E:\Guanlan-Sina\backend\app\api\routes\tianchou.py

# åº”è¯¥çœ‹åˆ°ï¼š
# 'device_sizes': np.array(api_params.get('device_sizes', ...
```

### 2. éªŒè¯å®¹å™¨ä»£ç 

```bash
# æ£€æŸ¥å®¹å™¨å†…ä»£ç 
docker exec guanlan-sina-backend-1 sh -c \
  "grep -A 3 'device_sizes' /app/app/api/routes/tianchou.py"

# åº”è¯¥çœ‹åˆ°ç›¸åŒçš„ np.array() åŒ…è£…
```

### 3. éªŒè¯åç«¯å¥åº·

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8000/api/v1/utils/health-check/
# åº”è¿”å›: true
```

### 4. éªŒè¯åŠŸèƒ½

```bash
# åˆ›å»ºæµ‹è¯•ä»»åŠ¡
curl -X POST http://localhost:8000/api/v1/tianchou/tasks \
  -H "Content-Type: application/json" \
  -d '{
    "name": "æµ‹è¯•ä»»åŠ¡",
    "industry_type": "light",
    "workshop_length": 80.0,
    "workshop_width": 60.0,
    "device_count": 10,
    "daily_output_value": 20000,
    "base_cost": 20000,
    "construction_rate": 3000,
    "benefit_multiplier": 200
  }'

# è·å–ä»»åŠ¡IDï¼Œç„¶åæŸ¥è¯¢çŠ¶æ€
curl http://localhost:8000/api/v1/tianchou/tasks/{task_id}

# åº”è¯¥çœ‹åˆ° status: "completed"
```

### 5. éªŒè¯ç»“æœ

```bash
# è·å–æ–¹æ¡ˆåˆ—è¡¨
curl http://localhost:8000/api/v1/tianchou/tasks/{task_id}/solutions

# åº”è¯¥è¿”å› 20 ä¸ªå¸•ç´¯æ‰˜æœ€ä¼˜è§£
```

---

## ç»éªŒæ•™è®­

### 1. ç±»å‹å®‰å…¨

**æ•™è®­**ï¼šPython çš„åŠ¨æ€ç±»å‹å¯èƒ½å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ã€‚

**æœ€ä½³å®è·µ**ï¼š
- åœ¨ API å±‚è¿›è¡Œç±»å‹è½¬æ¢å’ŒéªŒè¯
- ä½¿ç”¨ Pydantic æ¨¡å‹éªŒè¯è¾“å…¥
- æ·»åŠ ç±»å‹æ³¨è§£å’Œç±»å‹æ£€æŸ¥ï¼ˆmypyï¼‰

```python
# âœ… å¥½çš„åšæ³•
from typing import List
import numpy as np
from numpy.typing import NDArray

def process_data(data: List[List[float]]) -> NDArray[np.float64]:
    """å°†è¾“å…¥æ•°æ®è½¬æ¢ä¸º numpy æ•°ç»„"""
    return np.array(data, dtype=np.float64)
```

### 2. Docker å¼€å‘æµç¨‹

**æ•™è®­**ï¼šDocker å®¹å™¨å†…çš„ä»£ç ä¸ä¼šè‡ªåŠ¨æ›´æ–°ã€‚

**æœ€ä½³å®è·µ**ï¼š

| ç¯å¢ƒ | æ¨èæ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|-----|---------|------|------|
| å¼€å‘ | Volume æŒ‚è½½ + watch | ä»£ç å®æ—¶åŒæ­¥ | éœ€è¦é…ç½® |
| æµ‹è¯• | é‡æ–°æ„å»ºé•œåƒ | ç¯å¢ƒä¸€è‡´æ€§ | æ„å»ºè€—æ—¶ |
| ç”Ÿäº§ | CI/CD è‡ªåŠ¨æ„å»º | å¯è¿½æº¯ã€å¯å›æ»š | éœ€è¦åŸºç¡€è®¾æ–½ |

### 3. è°ƒè¯•ç­–ç•¥

**æ•™è®­**ï¼šå®¹å™¨åŒ–ç¯å¢ƒçš„è°ƒè¯•éœ€è¦ç‰¹æ®ŠæŠ€å·§ã€‚

**è°ƒè¯•æ¸…å•**ï¼š
1. âœ… æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼š`docker logs guanlan-sina-backend-1`
2. âœ… è¿›å…¥å®¹å™¨æ£€æŸ¥ï¼š`docker exec -it guanlan-sina-backend-1 sh`
3. âœ… éªŒè¯ä»£ç ç‰ˆæœ¬ï¼šæ£€æŸ¥æ–‡ä»¶å†…å®¹å’Œä¿®æ”¹æ—¶é—´
4. âœ… æµ‹è¯• API ç«¯ç‚¹ï¼šä½¿ç”¨ curl æˆ– Postman
5. âœ… æ£€æŸ¥ç¯å¢ƒå˜é‡ï¼š`docker exec guanlan-sina-backend-1 env`

### 4. ç‰ˆæœ¬æ§åˆ¶

**æ•™è®­**ï¼šä¿®å¤åº”è¯¥ç«‹å³æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ã€‚

**æœ€ä½³å®è·µ**ï¼š
```bash
# 1. ä¿®å¤ä»£ç 
# 2. æµ‹è¯•éªŒè¯
# 3. ç«‹å³æäº¤
git add backend/app/api/routes/tianchou.py
git commit -m "fix: ä¿®å¤å¤©ç­¹ç®—æ³•å‚æ•°ç±»å‹é”™è¯¯"

# 4. æ›´æ–°æ–‡æ¡£
git add docs/32-å¤©ç­¹ç®—æ³•é›†æˆ-é”™è¯¯ä¿®å¤æŒ‡å—.md
git commit -m "docs: æ·»åŠ å¤©ç­¹ç®—æ³•é”™è¯¯ä¿®å¤æŒ‡å—"
```

### 5. æ–‡æ¡£åŒ–

**æ•™è®­**ï¼šå¤æ‚çš„ä¿®å¤è¿‡ç¨‹åº”è¯¥æ–‡æ¡£åŒ–ï¼Œé¿å…é‡å¤è¸©å‘ã€‚

**æ–‡æ¡£æ¸…å•**ï¼š
- âœ… é”™è¯¯ç°è±¡å’Œæ—¥å¿—
- âœ… æ ¹æœ¬åŸå› åˆ†æ
- âœ… ä¿®å¤æ–¹æ¡ˆå’Œä»£ç 
- âœ… Docker ç›¸å…³æ³¨æ„äº‹é¡¹
- âœ… éªŒè¯æ­¥éª¤
- âœ… ç»éªŒæ•™è®­

---

## å¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker ps --filter "name=backend"

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs -f guanlan-sina-backend-1

# é‡å¯å®¹å™¨
docker restart guanlan-sina-backend-1

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker compose up -d --build backend

# è¿›å…¥å®¹å™¨
docker exec -it guanlan-sina-backend-1 sh

# å¤åˆ¶æ–‡ä»¶åˆ°å®¹å™¨
docker cp "local/path/file.py" container:/app/path/file.py

# æ¸…é™¤æ„å»ºç¼“å­˜
docker builder prune -f

# æŸ¥çœ‹é•œåƒ
docker images | grep backend
```

### æµ‹è¯• API

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8000/api/v1/utils/health-check/

# åˆ›å»ºä»»åŠ¡
curl -X POST http://localhost:8000/api/v1/tianchou/tasks \
  -H "Content-Type: application/json" \
  -d @test_request.json

# æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
curl http://localhost:8000/api/v1/tianchou/tasks/{task_id}

# è·å–æ–¹æ¡ˆåˆ—è¡¨
curl http://localhost:8000/api/v1/tianchou/tasks/{task_id}/solutions
```

---

## ç›¸å…³æ–‡æ¡£

- [24-å¤©ç­¹ç®—æ³•é›†æˆ-å®æ–½è¿›åº¦.md](./24-å¤©ç­¹ç®—æ³•é›†æˆ-å®æ–½è¿›åº¦.md) - å®æ–½è¿›åº¦è·Ÿè¸ª
- [26-å¤©ç­¹ç®—æ³•é›†æˆè®¾è®¡æ–¹æ¡ˆ-ç®€åŒ–ç‰ˆ.md](./26-å¤©ç­¹ç®—æ³•é›†æˆè®¾è®¡æ–¹æ¡ˆ-ç®€åŒ–ç‰ˆ.md) - è®¾è®¡æ–¹æ¡ˆ
- [03-éƒ¨ç½²æŒ‡å—.md](./03-éƒ¨ç½²æŒ‡å—.md) - Docker éƒ¨ç½²æŒ‡å—
- [04-å¼€å‘æŒ‡å—.md](./04-å¼€å‘æŒ‡å—.md) - å¼€å‘ç¯å¢ƒé…ç½®

---

## æ›´æ–°æ—¥å¿—

| æ—¥æœŸ | ç‰ˆæœ¬ | æ›´æ–°å†…å®¹ | ä½œè€… |
|------|------|---------|------|
| 2026-02-12 | 1.0 | åˆå§‹ç‰ˆæœ¬ï¼Œè®°å½•å¤©ç­¹ç®—æ³•ç±»å‹é”™è¯¯ä¿®å¤è¿‡ç¨‹ | Claude |

---

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š
- æäº¤ Issue åˆ°é¡¹ç›®ä»“åº“
- è”ç³»å¼€å‘å›¢é˜Ÿ
- æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£ï¼š`docs/` ç›®å½•

---

**æœ€åæ›´æ–°**: 2026-02-12
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²éªŒè¯
