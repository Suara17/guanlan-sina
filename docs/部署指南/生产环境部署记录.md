# 天工·弈控 生产环境部署指南

> 部署日期: 2026-02-25
> 服务器IP: 116.62.78.162
用户名root
密匙文件：file:///C:/Users/forzr/es.pem
## 一、服务器环境

### 系统要求
- Docker 29.2.1
- Docker Compose v5.0.2

### 已有服务（注意端口冲突）
- searxng: 8080
- xray: 1080

## 二、部署服务列表

| 服务 | 容器端口 | 主机端口 | 访问地址 |
|------|---------|---------|---------|
| 前端 (Frontend) | 80 | 3000 | http://116.62.78.162:3000 |
| 后端 API (Backend) | 8000 | 8000 | http://116.62.78.162:8000 |
| 数据库管理 (Adminer) | 8080 | 8081 | http://116.62.78.162:8081 |
| PostgreSQL | 5432 | 5432 | 内部访问 |
| Neo4j Browser | 7474 | 7474 | http://116.62.78.162:7474 |
| Neo4j Bolt | 7687 | 7687 | bolt://116.62.78.162:7687 |

## 三、登录凭证

### 数据库 (PostgreSQL)
- 用户名: `app`
- 密码: `TianGong2024SecurePwd!`
- 数据库: `app`

### 管理员账户
- 邮箱: `admin@example.com`
- 密码: `changethis`

> ⚠️ 生产环境请及时修改默认密码

### Neo4j 知识图谱
- 用户名: `neo4j`
- 密码: `12345678`

## 四、部署步骤

### 1. SSH 连接服务器
```bash
ssh -i "C:\Users\forzr\es.pem" root@116.62.78.162
```

### 2. 克隆项目并切换到正确分支
```bash
cd /root
git clone https://github.com/Suara17/guanlan-sina.git
cd guanlan-sina

# ⚠️ 重要：检查并切换到正确的分支！
# 默认克隆的是 main 分支，但最新代码可能在其他分支

# 查看所有分支
git branch -a

# 当前项目主要分支：
# - main: 主分支（稳定版本）
# - 20260212: 最新开发分支（包含天筹优化等功能）

# 切换到指定分支（例如 20260212）
git checkout 20260212
git pull origin 20260212
```

### 3. 创建环境变量文件
```bash
cat > .env << 'EOF'
# 项目配置
PROJECT_NAME=天工·弈控
ENVIRONMENT=production
STACK_NAME=guanlan-sina
DOMAIN=116.62.78.162

# Docker镜像
DOCKER_IMAGE_BACKEND=guanlan-sina-backend
DOCKER_IMAGE_FRONTEND=guanlan-sina-frontend
TAG=latest

# 数据库
POSTGRES_SERVER=db
POSTGRES_PORT=5432
POSTGRES_USER=app
POSTGRES_PASSWORD=TianGong2024SecurePwd!
POSTGRES_DB=app

# 认证
SECRET_KEY=<使用 openssl rand -hex 32 生成>
FIRST_SUPERUSER=admin@tiangong.com
FIRST_SUPERUSER_PASSWORD=Admin2024Secure!
ACCESS_TOKEN_EXPIRE_MINUTES=11520

# CORS
FRONTEND_HOST=http://116.62.78.162
BACKEND_CORS_ORIGINS=http://116.62.78.162,http://localhost:3000

# Neo4j 配置
NEO4J_URI=bolt://neo4j:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=12345678
NEO4J_DATABASE=neo4j
NEO4J_BROWSER_URL=http://116.62.78.162:7474
EOF
```

### 4. 创建 Docker 网络
```bash
docker network create traefik-public
```

### 5. 启动服务
```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
```

## 五、常用运维命令

### 查看服务状态
```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml ps
```

### 查看日志
```bash
# 所有服务日志
docker compose -f docker-compose.yml -f docker-compose.prod.yml logs -f

# 特定服务日志
docker compose -f docker-compose.yml -f docker-compose.prod.yml logs -f backend
docker compose -f docker-compose.yml -f docker-compose.prod.yml logs -f frontend
```

### 重启服务
```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml restart
```

### 停止服务
```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml down
```

### 更新部署

#### 方法一：服务器直接拉取（推荐）

```bash
cd /root/guanlan-sina

# 查看当前分支
git branch

# 拉取所有远程分支信息
git fetch --all

# ⚠️ 切换到正确的分支（不是 main 的情况）
# 例如切换到 20260212 分支
git checkout 20260212
git pull origin 20260212

# 如果有本地冲突，先暂存或清理
git stash                    # 暂存本地更改
# 或
git checkout .               # 放弃本地更改

# 重新构建并启动
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
```

#### 方法二：从本地上传（服务器无法访问 GitHub 时）

```bash
# 本地执行：上传代码到服务器
scp -i "C:\Users\forzr\es.pem" -r E:\Guanlan-Sina/* root@116.62.78.162:/root/guanlan-sina/

# 服务器执行：重新构建
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
```

#### 完整重建步骤（推荐用于重大更新）

```bash
# 1. 停止并删除容器
docker compose -f docker-compose.yml -f docker-compose.prod.yml down

# 2. 更新代码
git fetch --all
git checkout <目标分支>
git pull origin <目标分支>

# 3. 清理旧镜像缓存（可选）
docker system prune -f

# 4. 重新构建（不使用缓存）
docker compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache frontend backend

# 5. 启动服务
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

## 六、关键配置文件

### docker-compose.prod.yml
生产环境端口映射配置，用于覆盖默认配置暴露服务端口：

```yaml
services:
  db:
    ports:
      - "5432:5432"

  adminer:
    ports:
      - "8081:8080"

  backend:
    ports:
      - "8000:8000"

  frontend:
    ports:
      - "3000:80"

networks:
  traefik-public:
    external: false
```

### frontend/Dockerfile
前端构建配置：

```dockerfile
FROM node:20-alpine AS builder
ARG VITE_API_URL
WORKDIR /app
COPY package*.json ./
RUN npm ci --include=dev
COPY . .
ENV VITE_API_URL=${VITE_API_URL}
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

## 七、故障排查

### 容器无法启动
```bash
# 检查容器状态
docker ps -a

# 查看错误日志
docker logs <容器名>
```

### 端口被占用
```bash
# 查看端口占用
netstat -tlnp | grep <端口号>
```

### 数据库连接失败
```bash
# 检查数据库容器状态
docker compose ps db

# 进入数据库容器
docker exec -it guanlan-sina-db-1 psql -U app -d app
```

### Neo4j 连接问题
```bash
# 检查 Neo4j 状态
docker compose ps neo4j

# 查看 Neo4j 日志
docker logs guanlan-sina-neo4j-1
```

## 八、当前部署状态

> 最后更新: 2026-02-25

| 项目 | 值 |
|------|-----|
| 当前分支 | `20260212` |
| 最新提交 | `abb4f55` - fix(docker): 使用阿里云镜像源解决国内服务器构建问题 |
| 前端镜像 | guanlan-sina-frontend:latest |
| 后端镜像 | guanlan-sina-backend:latest |

### 数据迁移状态

| 数据库 | 状态 |
|--------|------|
| PostgreSQL | ✅ 已迁移（users: 2, production_lines: 15, optimization_tasks: 6, pareto_solutions: 37+） |
| Neo4j | ✅ 已迁移（节点: 514, 关系: 510） |

### 网络环境说明

服务器位于国内，存在以下网络限制：
- ❌ 无法直接访问 GitHub（连接超时）
- ❌ 无法直接访问 Debian 官方软件源（连接超时）
- ✅ 可通过 xray 代理（SOCKS5://127.0.0.1:1080）访问外网
- ✅ 可访问阿里云镜像源

### 网络问题解决方案

#### 1. Git 配置代理（拉取 GitHub 代码）

```bash
# 配置 git 使用本地代理
git config --global http.proxy socks5://127.0.0.1:1080
git config --global https.proxy socks5://127.0.0.1:1080

# 拉取代码
git pull origin 20260212

# 取消代理配置（可选）
git config --global --unset http.proxy
git config --global --unset https.proxy
```

#### 2. Dockerfile 使用国内镜像源

后端 Dockerfile 已修改为使用阿里云镜像源：

```dockerfile
# 使用阿里云镜像源（国内服务器网络优化）
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list && \
    sed -i 's/security.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list
```

#### 3. 数据库迁移处理

如果数据库表已存在但迁移记录不一致，使用以下命令标记：

```bash
# 查看当前迁移状态
docker exec guanlan-sina-backend-1 alembic current

# 查看待执行的迁移
docker exec guanlan-sina-backend-1 alembic heads

# 标记所有迁移为已完成（表已存在时）
docker exec guanlan-sina-backend-1 alembic stamp head
```

## 九、服务持续运行说明

### 自动启动机制
- Docker 容器设置了 `restart: unless-stopped` 策略
- 服务器重启后，容器会自动重新启动
- 除非明确执行 `docker compose down` 停止，否则服务会一直运行

### 可能导致服务中断的情况

| 情况 | 影响 | 解决方案 |
|-----|------|---------|
| 服务器重启 | 短暂中断，自动恢复 | 无需操作，容器自动重启 |
| Docker 服务重启 | 短暂中断 | `systemctl restart docker` |
| 容器崩溃 | 自动重启 | 检查日志排查原因 |
| 内存不足 | 可能被 OOM 杀掉 | 监控服务器资源 |
| 阿里云欠费 | 服务停止 | 及时充值 |

### 手动管理命令

```bash
# 停止所有服务
docker compose -f docker-compose.yml -f docker-compose.prod.yml down

# 启动所有服务
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# 重启所有服务
docker compose -f docker-compose.yml -f docker-compose.prod.yml restart
```

### 维护建议

1. **定期检查服务状态**
   ```bash
   docker ps
   ```

2. **设置监控告警**（阿里云云监控）
   - CPU 使用率告警
   - 内存使用率告警
   - 磁盘空间告警

3. **定期备份数据库**（见第十章节）

4. **定期检查日志**
   ```bash
   docker compose logs --tail 100 backend
   ```

## 十、备份与恢复

### 数据库备份
```bash
docker exec guanlan-sina-db-1 pg_dump -U app app > backup_$(date +%Y%m%d).sql
```

### 数据库恢复
```bash
cat backup.sql | docker exec -i guanlan-sina-db-1 psql -U app app
```

---

*文档版本: 1.3 | 更新日期: 2026-02-25*

### 更新日志
- v1.3 (2026-02-25): 更新部署状态，添加网络问题解决方案（代理配置、国内镜像源、迁移处理）
- v1.2 (2026-02-21): 添加服务持续运行说明和维护建议
- v1.1 (2026-02-21): 添加分支切换说明、完整重建步骤、当前部署状态
- v1.0 (2026-02-21): 初始版本
