# 天工·弈控 生产环境部署指南

> 部署日期: 2026-02-21
> 服务器IP: 116.62.78.162

## 一、服务器环境

### 系统要求
- Docker 29.2.1
- Docker Compose v5.0.2

### 已有服务（注意端口冲突）
- searxng: 8080
- xray: 1080

## 二、部署服务列表

| 服务 | 容器端口 | 主机端口 | 访问地址 |
|------|---------|---------|---------|
| 前端 (Frontend) | 80 | 3000 | http://116.62.78.162:3000 |
| 后端 API (Backend) | 8000 | 8000 | http://116.62.78.162:8000 |
| 数据库管理 (Adminer) | 8080 | 8081 | http://116.62.78.162:8081 |
| PostgreSQL | 5432 | 5432 | 内部访问 |
| Neo4j Browser | 7474 | 7474 | http://116.62.78.162:7474 |
| Neo4j Bolt | 7687 | 7687 | bolt://116.62.78.162:7687 |

## 三、登录凭证

### 数据库 (PostgreSQL)
- 用户名: `app`
- 密码: `TianGong2024SecurePwd!`
- 数据库: `app`

### 管理员账户
- 邮箱: `admin@tiangong.com`
- 密码: `Admin2024Secure!`

### Neo4j 知识图谱
- 用户名: `neo4j`
- 密码: `12345678`

## 四、部署步骤

### 1. SSH 连接服务器
```bash
ssh -i "C:\Users\forzr\es.pem" root@116.62.78.162
```

### 2. 克隆项目
```bash
cd /root
git clone https://github.com/Suara17/guanlan-sina.git
cd guanlan-sina
```

### 3. 创建环境变量文件
```bash
cat > .env << 'EOF'
# 项目配置
PROJECT_NAME=天工·弈控
ENVIRONMENT=production
STACK_NAME=guanlan-sina
DOMAIN=116.62.78.162

# Docker镜像
DOCKER_IMAGE_BACKEND=guanlan-sina-backend
DOCKER_IMAGE_FRONTEND=guanlan-sina-frontend
TAG=latest

# 数据库
POSTGRES_SERVER=db
POSTGRES_PORT=5432
POSTGRES_USER=app
POSTGRES_PASSWORD=TianGong2024SecurePwd!
POSTGRES_DB=app

# 认证
SECRET_KEY=<使用 openssl rand -hex 32 生成>
FIRST_SUPERUSER=admin@tiangong.com
FIRST_SUPERUSER_PASSWORD=Admin2024Secure!
ACCESS_TOKEN_EXPIRE_MINUTES=11520

# CORS
FRONTEND_HOST=http://116.62.78.162
BACKEND_CORS_ORIGINS=http://116.62.78.162,http://localhost:3000

# Neo4j 配置
NEO4J_URI=bolt://neo4j:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=12345678
NEO4J_DATABASE=neo4j
NEO4J_BROWSER_URL=http://116.62.78.162:7474
EOF
```

### 4. 创建 Docker 网络
```bash
docker network create traefik-public
```

### 5. 启动服务
```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
```

## 五、常用运维命令

### 查看服务状态
```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml ps
```

### 查看日志
```bash
# 所有服务日志
docker compose -f docker-compose.yml -f docker-compose.prod.yml logs -f

# 特定服务日志
docker compose -f docker-compose.yml -f docker-compose.prod.yml logs -f backend
docker compose -f docker-compose.yml -f docker-compose.prod.yml logs -f frontend
```

### 重启服务
```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml restart
```

### 停止服务
```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml down
```

### 更新部署
```bash
# 拉取最新代码（如服务器可访问GitHub）
git pull

# 或从本地上传文件
# scp -i "密钥路径" 文件 root@116.62.78.162:/root/guanlan-sina/

# 重新构建并启动
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
```

## 六、关键配置文件

### docker-compose.prod.yml
生产环境端口映射配置，用于覆盖默认配置暴露服务端口：

```yaml
services:
  db:
    ports:
      - "5432:5432"

  adminer:
    ports:
      - "8081:8080"

  backend:
    ports:
      - "8000:8000"

  frontend:
    ports:
      - "3000:80"

networks:
  traefik-public:
    external: false
```

### frontend/Dockerfile
前端构建配置：

```dockerfile
FROM node:20-alpine AS builder
ARG VITE_API_URL
WORKDIR /app
COPY package*.json ./
RUN npm ci --include=dev
COPY . .
ENV VITE_API_URL=${VITE_API_URL}
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

## 七、故障排查

### 容器无法启动
```bash
# 检查容器状态
docker ps -a

# 查看错误日志
docker logs <容器名>
```

### 端口被占用
```bash
# 查看端口占用
netstat -tlnp | grep <端口号>
```

### 数据库连接失败
```bash
# 检查数据库容器状态
docker compose ps db

# 进入数据库容器
docker exec -it guanlan-sina-db-1 psql -U app -d app
```

### Neo4j 连接问题
```bash
# 检查 Neo4j 状态
docker compose ps neo4j

# 查看 Neo4j 日志
docker logs guanlan-sina-neo4j-1
```

## 八、备份与恢复

### 数据库备份
```bash
docker exec guanlan-sina-db-1 pg_dump -U app app > backup_$(date +%Y%m%d).sql
```

### 数据库恢复
```bash
cat backup.sql | docker exec -i guanlan-sina-db-1 psql -U app app
```

---

*文档版本: 1.0 | 更新日期: 2026-02-21*
