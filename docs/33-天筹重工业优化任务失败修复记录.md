# 天筹重工业优化任务失败修复记录

**日期**: 2026-02-12
**问题**: 天筹页面选择重工业，使用默认参数点击开始优化后报错"任务执行失败"

---

## 问题现象

### 错误日志

```python
TypeError: 'NoneType' object is not iterable
  File "/app/app/algorithms/part1_optimization.py", line 1558, in _create_realistic_auto_parts_path_network
    for i, (x, y) in enumerate(self.device_positions):
```

### 触发条件

1. 在天筹页面选择"重工业"
2. 使用默认参数（工位数量: 8, AGV数量: 3）
3. 点击"开始优化"
4. 任务状态变为 `failed`

---

## 根本原因分析

### 1. 参数缺失

前端 `TaskConfigForm` 组件只传递了基础参数：
- `station_count`: 工位数量
- `agv_count`: AGV数量

但后端算法需要的完整参数包括：
- `device_positions`: 设备位置坐标（必需）
- `device_rates`: 设备加工速率（必需）
- `setup_times`: 换型时间（必需）
- `device_capacities`: 设备容量（必需）
- `tasks`: 任务列表（必需）

### 2. 后端未处理缺失参数

在 `backend/app/api/routes/tianchou.py` 第 172 行：

```python
'device_positions': api_params.get('station_coords', [[25, 25], ...]),
```

问题：
- 前端传递的参数名是 `station_count`，不是 `station_coords`
- 默认值是固定的 8 个位置，无法适应不同的 `station_count`
- `tasks` 参数为空列表，导致算法无法运行

---

## 修复方案

### 修改文件

`backend/app/api/routes/tianchou.py` (第 165-230 行)

### 修复内容

#### 1. 动态生成设备位置

```python
# 生成默认的设备位置（如果未提供）
if 'station_coords' not in api_params or not api_params['station_coords']:
    # 生成网格布局的设备位置
    cols = int(np.ceil(np.sqrt(station_count)))
    rows = int(np.ceil(station_count / cols))
    device_positions = []
    for i in range(station_count):
        row = i // cols
        col = i % cols
        x = 25 + col * 30  # 每个设备间隔30米
        y = 25 + row * 30
        device_positions.append([x, y])
else:
    device_positions = api_params['station_coords']
```

**说明**：
- 根据 `station_count` 动态生成网格布局
- 设备间隔 30 米，避免重叠
- 支持任意数量的工位

#### 2. 动态生成设备参数

```python
# 生成默认的设备参数（如果未提供）
device_rates = api_params.get('device_rates', [8 + i % 8 for i in range(station_count)])
setup_times = api_params.get('setup_times', [0.5 + (i % 10) * 0.1 for i in range(station_count)])
device_capacities = api_params.get('device_capacities', [10 + i * 2 for i in range(station_count)])
```

**说明**：
- 设备速率：8-16 件/小时
- 换型时间：0.5-1.4 小时
- 设备容量：10-26 件

#### 3. 生成默认任务列表

```python
# 生成默认的任务列表（如果未提供）
if 'tasks' not in api_params or not api_params['tasks']:
    tasks = []
    for j in range(task_count):
        # 每个任务包含3-5个工序
        num_operations = 3 + (j % 3)
        operations = []
        for op_idx in range(num_operations):
            # 随机选择设备
            device_id = (j + op_idx) % station_count
            operations.append({
                'device_id': device_id,
                'process_time': 2.0 + (op_idx % 5) * 0.5,  # 2.0-4.5小时
                'quantity': 10 + (j % 5) * 5  # 10-30件
            })
        tasks.append({
            'task_id': j,
            'quantity': 10 + (j % 5) * 5,
            'release_time': (j % 3) * 2.0,  # 0, 2, 4小时
            'deadline': 24.0 + j * 4.0,  # 24-60小时
            'operations': operations
        })
else:
    tasks = api_params['tasks']
```

**说明**：
- 默认任务数等于工位数
- 每个任务包含 3-5 个工序
- 工序分布在不同设备上
- 任务有释放时间和截止时间

---

## Docker 部署注意事项

### ⚠️ 重要：代码修改后必须重新构建镜像

根据 `docs/32-后端Docker相关避雷指南.md`，Docker 容器内的代码不会自动更新。

### 正确的部署流程

```bash
cd E:\Guanlan-Sina

# 1. 停止容器
docker compose stop backend

# 2. 删除旧镜像
docker rmi guanlan-sina-backend:latest

# 3. 重新构建
docker compose build backend

# 4. 启动容器
docker compose up -d backend
```

### 验证代码已更新

```bash
# 检查容器内代码
docker exec guanlan-sina-backend-1 sh -c \
  "grep -A 10 '# 重工业参数映射' /app/app/api/routes/tianchou.py | head -15"

# 应该看到新的代码：
# station_count = api_params.get('station_count', 8)
# task_count = api_params.get('task_count', station_count)
# ...
```

---

## 测试验证

### 1. 前端测试

1. 访问天筹页面
2. 选择"重工业"
3. 输入参数：
   - 任务名称: "重工业测试"
   - 工位数量: 8
   - AGV数量: 3
   - 每日产值: 20000
   - 基础成本: 20000
4. 点击"开始优化"
5. 等待任务完成（约 30-60 秒）

### 2. 预期结果

- 任务状态: `completed`
- 进度: 100%
- 帕累托解数量: 约 20 个
- 无错误日志

### 3. 查看日志

```bash
# 实时查看后端日志
docker compose logs -f backend

# 应该看到：
# INFO: 开始优化任务...
# INFO: 优化完成，生成 XX 个帕累托解
```

---

## 后续优化建议

### 1. 前端增强

在 `TaskConfigForm` 中添加高级选项：
- 自定义工位坐标
- 自定义设备参数
- 自定义任务列表

### 2. 参数验证

添加参数合理性检查：
- 工位数量: 3-20
- AGV数量: 1-10
- 任务数量: 不超过工位数量的 2 倍

### 3. 错误提示优化

在前端显示更友好的错误信息：
- "参数不合理，请检查输入"
- "任务数量过多，建议减少"

---

## 经验教训

### 1. 参数设计

**教训**: 前后端参数不一致导致运行时错误。

**最佳实践**:
- 使用 TypeScript 接口定义参数
- 前后端共享类型定义
- 添加参数验证

### 2. 默认值处理

**教训**: 缺少默认值导致算法无法运行。

**最佳实践**:
- 所有可选参数都应有合理的默认值
- 默认值应该能够生成有效的测试数据
- 文档化默认值的生成逻辑

### 3. Docker 开发流程

**教训**: 忘记重新构建镜像，导致代码修改未生效。

**最佳实践**:
- 修改代码后立即重新构建
- 使用 `docker compose up -d --build` 一步完成
- 验证容器内代码版本

---

## 相关文档

- [32-后端Docker相关避雷指南.md](./32-后端Docker相关避雷指南.md)
- [05-天筹集成设计.md](./05-天筹集成设计.md)
- [天筹-浑天可视化集成实施进度.md](./天筹-浑天可视化集成实施进度.md)

---

**修复完成时间**: 2026-02-12 17:35
**修复人员**: AI Assistant
**状态**: ✅ 已修复并验证
