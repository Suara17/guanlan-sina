# 司南（SiNan）决策助手功能设计

## 功能架构

```
司南系统
├── 问题判断模块
│   ├── 知识图谱诊断（问题原因分析）
│   ├── 列举解决方案
│   │   ├── 方案详情（风险/损失）
│   │   └── 提出最佳解决方案
│   └── 执行方案
│
├── 选择执行方案模块
│   ├── 方案执行页面
│   │   ├── 手动上传方案
│   │   └── 选择推荐方案
│   └── 执行可视化
│       ├── 方案完成速度
│       └── 实时执行情况
│
└── 历史复盘模块
    ├── 问题描述
    ├── 历史问题详情
    │   ├── 采取方案
    │   └── 实际效果、预计效果对比
    └── 案例库归档
```

---

## 1. 异常提醒与列表

### 1.1 实时推送机制

- WebSocket长连接保持（基于Starlette集成）
- 桌面通知（浏览器Notification API）
- 移动端推送（企业微信/钉钉集成）

### 1.2 异常列表设计

| 字段 | 说明 | 示例 |
|-----|------|-----|
| 严重程度 | 高/中/低，影响ROI排序 | 高（预计损失>10万元） |
| 触发时间 | 异常首次检测时间 | 2026-01-12 14:32:15 |
| 缺陷类型 | 具体问题分类 | 划痕、尺寸超差 |
| 影响范围 | 影响工位数量/在制品数 | 影响W05-W08共4个工位 |
| 当前状态 | 未处理/处置中/已关闭 | 处置中 |
| 责任人 | 当前处理人 | 张工 |
| 操作 | 查看/处置/关闭 | [进入诊断] |

---

## 2. 知识图谱诊断详情页

### 2.1 图谱可视化

- 中心节点：当前异常问题
- 一级节点：可能原因（概率标注）
- 二级节点：支持证据（参数/设备/环境）
- 边关系：因果关系（实线）、相关性（虚线）

### 2.2 交互功能

- 节点点击展开详情面板
- 节点搜索与高亮
- 证据链路径追踪（从异常到根因的完整路径高亮）
- 可导出知识图谱PNG/SVG

### 2.3 证据列表

```json
{
  "evidences": [
    {
      "type": "工艺参数异常",
      "parameter": "温度",
      "normal_range": "180-200°C",
      "current_value": "215°C",
      "deviation": "+15°C",
      "confidence": 0.92
    },
    {
      "type": "设备状态",
      "equipment": "刀具#3",
      "usage_time": "1520小时",
      "maintenance_threshold": "1500小时",
      "alert_level": "建议更换"
    }
  ]
}
```

---

## 3. 处置方案推荐

### 3.1 方案对比表

| 方案名称 | 类型 | 预计停机时间 | 成功率 | 不良外流风险 | 期望损失 | ROI |
|---------|------|------------|-------|------------|---------|-----|
| 方案A：调整工艺参数 | 轻资产 | 0.5小时 | 85% | 低 | 2.3万元 | 1:5.2 |
| 方案B：更换刀具 | 中资产 | 1.5小时 | 95% | 极低 | 5.1万元 | 1:3.8 |
| 方案C：重新布局 | 重资产 | 8小时 | 98% | 极低 | 12.6万元 | 1:2.1 |

### 3.2 方案可视化

**1. 轻资产方案（参数调整）**
   - 参数调整前后对比表
   - 预期效果曲线（良率提升趋势）

**2. 中资产方案（设备移动）**
   - 布局对比图（Before/After并排展示）
   - 拖拽式设备位置变化动画
   - 物流路径重新规划（箭头标注）

**3. 重资产方案（产线重构）**
   - 3D阵列布局对比
   - AGV路径调整动画
   - 关键风险点标注（红色感叹号）

### 3.3 浑天仿真结果嵌入

```
仿真报告摘要：
- 方案实施后预计产能提升：12%
- 瓶颈工位由W05转移至W12
- 关键风险：设备搬迁期间需停线8小时
- ROI预演：投入12.6万元，年化收益52万元
```

---

## 4. 执行与复盘

### 4.1 工单生成

```json
{
  "work_order_id": "WO-20260112-001",
  "solution_id": "SOL-A-0032",
  "solution_name": "调整W05工位温度参数",
  "responsible_person": "张工",
  "estimated_duration": "0.5小时",
  "instructions": [
    "1. 停止W05工位进料",
    "2. 将加热温度从215°C调整至190°C",
    "3. 运行10个测试件验证",
    "4. 确认良率恢复后恢复正常生产"
  ],
  "risk_warnings": [
    "调整过程中需持续监控下游W06工位温度"
  ]
}
```

### 4.2 执行填写表单

- 实际停机时长（与预计对比）
- 是否成功（是/否/部分成功）
- 实际损失（金额）
- 意外情况说明（文本框）
- 后续改进建议（可选）

### 4.3 自动复盘归档

- 方案成功率更新（历史案例库）
- 阈值自动调整（机器学习模型迭代）
- 相似案例推荐引擎优化

---

## 5. 历史案例库

### 5.1 搜索与过滤

- 关键词搜索（缺陷类型、工位、时间）
- 多维度过滤（成功率、损失金额、处理时长）
- 排序（按时间/相似度/成功率）

### 5.2 案例详情页

```
案例编号：CASE-20260105-018
触发时间：2026-01-05 09:15:32
问题描述：W05工位连续5件划痕NG
诊断结论：刀具磨损 + 冷却液浓度不足
采取方案：更换刀具 + 补充冷却液
预期效果：不良率从15%降至2%，停机1.2小时
实际效果：不良率降至1.8%，停机1.5小时
偏差分析：停机时间超预期，因刀具库存不足需临时调配
改进措施：增加刀具安全库存至5件
```

---

## 6. 司南API接口

| 接口路径 | 方法 | 说明 | 权限 |
|---------|------|------|------|
| `/api/v1/alerts/list` | GET | 异常列表 | alert:view |
| `/api/v1/alerts/{id}` | GET | 异常详情 | alert:view |
| `/api/v1/diagnosis/{anomalyId}` | GET | 诊断结果 | diagnosis:view |
| `/api/v1/solutions/{anomalyId}` | GET | 方案列表 | solution:view |
| `/api/v1/solutions/{id}/simulate` | POST | 触发仿真 | solution:simulate |
| `/api/v1/work-orders` | POST | 创建工单 | workorder:create |
| `/api/v1/work-orders/{id}` | PUT | 更新工单 | workorder:update |
| `/api/v1/work-orders/{id}/complete` | POST | 完成工单 | workorder:execute |
| `/api/v1/cases/search` | GET | 搜索案例 | case:view |
| `/api/v1/cases/{id}` | GET | 案例详情 | case:view |

---

## 7. 数据字典

### 7.1 枚举值定义

```python
# 异常严重程度
class Severity(str, Enum):
    LOW = 'low'           # 低：不良率<5%，可延后处理
    MEDIUM = 'medium'     # 中：不良率5%-10%，当班处理
    HIGH = 'high'         # 高：不良率10%-20%，1小时内处理
    CRITICAL = 'critical' # 严重：不良率>20%或停线，立即处理

# 异常状态
class AnomalyStatus(str, Enum):
    OPEN = 'open'         # 未处理
    ASSIGNED = 'assigned' # 已分配
    IN_PROGRESS = 'in_progress' # 处理中
    RESOLVED = 'resolved' # 已解决
    CLOSED = 'closed'     # 已关闭

# 方案类型
class SolutionType(str, Enum):
    PARAMETER_ADJUSTMENT = 'parameter_adjustment' # 参数调整
    EQUIPMENT_MAINTENANCE = 'equipment_maintenance' # 设备维护
    MATERIAL_CHANGE = 'material_change'           # 物料更换
    LAYOUT_OPTIMIZATION = 'layout_optimization'   # 布局优化
    PROCESS_REDESIGN = 'process_redesign'         # 工艺重新设计

# 工单状态
class WorkOrderStatus(str, Enum):
    PENDING = 'pending'     # 待执行
    IN_PROGRESS = 'in_progress' # 执行中
    COMPLETED = 'completed' # 已完成
    CANCELLED = 'cancelled' # 已取消

# 执行结果
class ExecutionResult(str, Enum):
    SUCCESS = 'success'           # 成功
    PARTIAL_SUCCESS = 'partial_success' # 部分成功
    FAILED = 'failed'             # 失败
```