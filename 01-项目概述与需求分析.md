# 开物经纬科技公司可视化平台需求分析及系统设计说明书

## 文档版本信息
- **版本号**: v1.1
- **编制日期**: 2026年1月
- **编制人**: 系统架构团队
- **适用范围**: 观澜(GuanLan)生产可视化门户 + 司南(SiNan)决策助手
- **修订说明**: 适配全栈模板（FastAPI + React 19 + TypeScript + Vite），替换原NestJS + React技术栈；调整消息中间件为Celery + Redis；扩展数据库支持；保持核心功能需求不变。

---

## 第一章 项目概述

### 1.1 项目背景

开物经纬科技公司致力于构建智能制造可视化平台，通过整合底层四大核心模块（洞微、格物、天筹、浑天）的数据与决策能力，为生产制造企业提供统一的可视化门户与决策支持系统。

### 1.2 系统定位

本项目包含两个核心子系统：

**观澜（GuanLan）- 生产可视化门户**
- 面向对象：管理层、现场人员
- 核心价值：提供"生产节奏 + 质量指标"统一总览
- 解决痛点：消除"去现场看、去系统查"的信息割裂

**司南（SiNan）- 决策助手**
- 面向对象：工艺工程师、质量工程师、现场主管
- 核心价值：提供"提醒 → 诊断 → 处置 → 复盘"完整闭环
- 解决痛点：结构化、可解释、可落地的异常处理

### 1.3 项目目标

1. **数据统一**: 建立统一数据总线，确保数据口径一致性
2. **实时透明**: 生产状态实时可视，异常秒级响应
3. **智能决策**: 基于AI模型的诊断分析与方案推荐
4. **闭环管理**: 从发现问题到处置复盘的完整追溯
5. **价值落地**: 支撑"检测提速 → 全局秩序优化"价值链

---

## 第二章 用户角色与使用场景分析

### 2.1 用户角色矩阵

| 角色类型 | 主要使用系统 | 核心诉求 | 使用频率 |
|---------|------------|---------|---------|
| 管理层（厂长/生产经理） | 观澜 | 整体生产节奏、良率趋势、完工预测 | 每日查看 |
| 工艺/质量工程师 | 司南 + 观澜 | 深度诊断、追溯分析、方案验证 | 全天候使用 |
| 现场主管/操作员 | 观澜 + 司南 | 实时看板、异常提醒、处置指令 | 实时监控 |
| 维护/设备人员 | 司南 | 设备调整指令、物流路径变更 | 按需使用 |

### 2.2 典型使用场景

#### 场景1：管理层晨会巡检
```
用户路径：
登录 → 选择工厂/生产线 → 查看生产总览仪表盘
→ 关注：实时看板（进度、良率、预计完工时间）
→ 发现瓶颈工位 → 点击进入工位详情 → 查看WIP深度
→ 切换至历史趋势 → 导出周报PDF
```

#### 场景2：工程师异常处理
```
用户路径：
收到司南桌面通知（不良率超阈值）→ 点击进入问题判断页面
→ 查看诊断详情（知识图谱、证据链）
→ 对比多个处置方案（ROI预演）
→ 选择推荐方案 → 生成执行工单 → 推送至现场
→ 执行后填写实际效果 → 自动归档案例库
```

#### 场景3：现场操作员实时监控
```
用户路径：
车间大屏显示观澜看板 → 实时监控工位状态
→ 发现红色告警（连续NG） → 手持终端扫码
→ 查看司南推送的处置建议 → 按指令调整参数
→ 确认执行完成 → 状态更新至系统
```

---

## 第三章 非功能性需求

### 3.1 性能要求

| 性能指标 | 目标值 | 验收标准 |
|---------|-------|---------|
| 页面首次加载时间 | < 2秒 | 90%分位 |
| 实时数据更新延迟 | < 3秒 | WebSocket推送 |
| 并发用户支持 | ≥ 100人 | 单产线规模 |
| 大屏渲染帧率 | ≥ 30fps | 车间看板模式 |
| 数据库查询响应 | < 500ms | 95%分位 |
| 图像加载时间 | < 1秒 | CDN加速 |

**优化策略**:
1. 前端：代码分割、懒加载、虚拟滚动
2. 后端：Redis缓存、数据库索引优化
3. 网络：CDN静态资源加速、Gzip压缩
4. 实时通信：WebSocket连接池、消息队列削峰

### 3.2 安全性与权限

#### 3.2.1 RBAC权限模型

```
角色层级：
├── 超级管理员（全部权限）
├── 厂长（查看所有数据 + 审批处置方案）
├── 生产经理（查看 + 编辑生产计划）
├── 工艺工程师（查看 + 诊断 + 执行处置）
├── 质量工程师（查看 + 诊断 + 复盘分析）
├── 现场主管（查看工位数据 + 执行指令）
└── 操作员（查看分配工位 + 提交执行结果）
```

**权限粒度**:
- 功能权限：页面访问、按钮操作
- 数据权限：产线范围、工位范围
- 操作权限：查看/编辑/执行/审批/删除

#### 3.2.2 安全措施

1. **数据传输安全**
   - HTTPS加密传输
   - WebSocket使用WSS协议
   - API请求签名验证

2. **数据存储安全**
   - 敏感字段加密（工艺参数、成本数据）
   - 脱敏展示（部分用户只显示趋势不显示具体值）
   - 定期数据备份（每日全量 + 实时增量）

3. **操作审计**
   - 完整操作日志（用户、时间、操作、IP、结果）
   - 关键操作二次确认（删除案例、审批方案）
   - 异常行为告警（非工作时间登录、频繁失败）

4. **单点登录**
   - 企业微信OAuth 2.0
   - 钉钉扫码登录
   - LDAP集成（对接企业AD域）

### 3.3 可靠性与可维护性

#### 3.3.1 数据口径统一

**统一数据服务层**:
```
所有页面的"良率"指标必须调用同一服务：
GET /api/metrics/yield-rate?line={line_id}&time_range={range}

数据来源标注：
{
  "value": 95.2,
  "unit": "%",
  "source_module": "洞微检测",
  "data_timestamp": "2026-01-12T14:35:00Z",
  "calculation_method": "合格品数/总产出数"
}
```

#### 3.3.2 可追溯性设计

**鼠标悬停显示元数据**:
```html
<div class="metric-card"
     data-source="洞微"
     data-timestamp="2026-01-12T14:35:00Z"
     title="数据来源：洞微检测模块
最后更新：2026-01-12 14:35:00
计算方式：实时统计">
  良率：95.2%
</div>
```

#### 3.3.3 动作可落地

**MES系统集成**:
```python
# 方案执行后自动推送至MES
import requests

def push_to_mes(work_order):
    requests.post(
        "/mes/api/work-orders",
        json={
            "order_type": "parameter_adjustment",
            "equipment_id": "W05-HEATER-01",
            "parameter_name": "temperature",
            "target_value": 190,
            "operator": "张工",
            "deadline": "2026-01-12T16:00:00Z"
        }
    )
```

**PLC指令下发**:
```
支持自动化设备的参数远程调整：
- Modbus TCP协议写寄存器
- OPC UA节点值修改
- 执行前需人工二次确认
```

**可打印工单**:
- 生成PDF格式工单（包含二维码）
- 现场扫码查看详细指令
- 执行完成后扫码回传结果

### 3.4 可扩展性

#### 3.4.1 模块化前端组件

**组件库清单**:
```
@company/viz-components
├── DashboardCard (仪表盘卡片)
├── KnowledgeGraph (知识图谱)
├── LayoutComparison (布局对比)
├── GanttChart (甘特图)
├── HeatMap (热力图)
├── ParetoChart (帕累托图)
├── ImageWall (图像墙)
└── SolutionTable (方案对比表)
```

**组件复用示例**:
```tsx
import KnowledgeGraph from '@company/viz-components/knowledge-graph';

function App() {
  return (
    <KnowledgeGraph
      data={diagnosisData}
      centerNode="划痕异常"
      onNodeClick={handleNodeClick}
      highlightPath={evidencePath}
    />
  );
}
```

#### 3.4.2 事件驱动架构

**消息总线设计**:
```
Celery + Redis Topics:
- inspection.defect.detected (洞微检测事件)
- production.flow.updated (流速更新)
- diagnosis.completed (格物诊断完成)
- solution.recommended (天筹方案推荐)
- simulation.finished (浑天仿真结果)

观澜订阅：inspection.*, production.*
司南订阅：diagnosis.*, solution.*, simulation.*
```

**事件格式规范**:
```json
{
  "event_id": "evt-20260112-14350001",
  "event_type": "inspection.defect.detected",
  "source_module": "洞微",
  "timestamp": "2026-01-12T14:35:00Z",
  "payload": {
    "line_id": "LINE-A",
    "station_id": "W05",
    "defect_type": "划痕",
    "severity": "high",
    "image_url": "https://cdn.../defect-001.jpg"
  }
}
```

#### 3.4.3 多语言与主题

**国际化支持**:
```javascript
// i18n配置
const messages = {
  'zh-CN': {
    'dashboard.title': '生产总览',
    'quality.yield_rate': '良率'
  },
  'en-US': {
    'dashboard.title': 'Production Overview',
    'quality.yield_rate': 'Yield Rate'
  }
};
```

**主题切换**:
```css
/* 深色主题 */
:root[data-theme='dark'] {
  --bg-primary: #1a1a1a;
  --text-primary: #ffffff;
  --chart-line: #00ff88;
}

/* 浅色主题 */
:root[data-theme='light'] {
  --bg-primary: #ffffff;
  --text-primary: #333333;
  --chart-line: #1890ff;
}
```

---

## 附录

### 附录A：技术术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| 良率 | Yield Rate | 合格品数量 / 总产出数量 |
| 不良率 | Defect Rate | 不合格品数量 / 总产出数量 |
| CT | Cycle Time | 工位节拍时间 |
| WIP | Work In Process | 在制品库存 |
| ROI | Return On Investment | 投资回报率 |
| NG | No Good | 不良品 |
| 帕累托图 | Pareto Chart | 80/20法则图表 |
| 瓶颈工位 | Bottleneck Station | 限制产线流速的工位 |
| 堵塞 | Starvation | 工位前积压过多 |
| 饥饿 | Blockage | 工位等待上游供料 |

### 附录B：参考资料

1. **技术文档**
   - React官方文档: https://react.dev
   - FastAPI官方文档: https://fastapi.tiangolo.com
   - ECharts文档: https://echarts.apache.org
   - AntV G6文档: https://g6.antv.antgroup.com

2. **设计规范**
   - shadcn/ui设计规范
   - Material Design指南
   - Python PEP8风格指南

3. **最佳实践**
   - 《Clean Code》- Robert C. Martin
   - 《Designing Data-Intensive Applications》- Martin Kleppmann
   - 微服务架构设计模式

---

**文档修订记录**

| 版本 | 日期 | 修订人 | 修订内容 |
|------|------|--------|---------|
| v1.0 | 2026-01-12 | 架构团队 | 初始版本，完成需求分析与系统设计 |
| v1.1 | 2026-01-12 | 架构团队 | 适配FastAPI + React 19 + TypeScript + Vite模板，替换技术栈；调整代码示例、结构和部署配置 |
| v1.2 | 2026-01-12 | 架构团队 | 更正前端技术栈为React 19 + TypeScript + Vite，修正组件示例和参考资料 |
