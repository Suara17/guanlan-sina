# 技术架构设计

## 系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                     用户层                                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ PC浏览器  │  │ 移动APP   │  │ 车间大屏  │              │
│  └──────────┘  └──────────┘  └──────────┘              │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  前端应用层                                │
│  ┌─────────────────────┐  ┌─────────────────────┐      │
│  │   观澜前端应用        │  │   司南前端应用        │      │
│  │   Nuxt.js + Vue.js   │  │   Nuxt.js + Vue.js   │      │
│  │   Ant Design Vue     │  │   Ant Design Vue     │      │
│  │   ECharts + G6       │  │   ECharts + G6       │      │
│  └─────────────────────┘  └─────────────────────┘      │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  API网关层                                │
│           Traefik + API Gateway                          │
│  ┌──────────────────────────────────────────────┐      │
│  │ 认证鉴权 | 路由转发 | 限流熔断 | 日志监控      │      │
│  └──────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  应用服务层                                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │观澜服务   │  │司南服务   │  │公共服务   │              │
│  │FastAPI    │  │FastAPI    │  │FastAPI    │              │
│  └──────────┘  └──────────┘  └──────────┘              │
│  ┌──────────────────────────────────────────┐          │
│  │    WebSocket服务（Starlette集成）          │          │
│  └──────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  消息中间件                                │
│              Celery + Redis                              │
│  ┌─────────────────────────────────────────────────┐  │
│  │ Tasks: inspection.* | diagnosis.* | solution.*  │  │
│  └─────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  数据服务层                                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │洞微模块   │  │格物模块   │  │天筹模块   │              │
│  │(检测)     │  │(诊断)     │  │(决策)     │              │
│  └──────────┘  └──────────┘  └──────────┘              │
│  ┌──────────┐                                           │
│  │浑天模块   │                                           │
│  │(仿真)     │                                           │
│  └──────────┘                                           │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  数据存储层                                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │PostgreSQL │  │InfluxDB   │  │  Neo4j    │              │
│  │(业务数据) │  │(时序数据) │  │(知识图谱) │              │
│  └──────────┘  └──────────┘  └──────────┘              │
│  ┌──────────┐  ┌──────────┐                             │
│  │  Redis    │  │  MinIO    │                             │
│  │(缓存)     │  │(对象存储) │                             │
│  └──────────┘  └──────────┘                             │
└─────────────────────────────────────────────────────────┘
```

---

## 1. 前端技术栈详细设计

### 1.1 技术选型

| 技术分类 | 技术选型 | 版本 | 用途说明 |
|---------|---------|------|---------|
| 核心框架 | Vue.js | 3.x | UI组件化开发 |
| 开发语言 | TypeScript | 5.x | 类型安全与代码提示 |
| 状态管理 | Pinia | 2.x | 轻量级状态管理 |
| UI组件库 | Ant Design Vue | 4.x | 企业级UI组件 |
| 图表库 | ECharts | 5.x | 统计图表（折线/柱状/饼图） |
| 图表库 | AntV G6 | 5.x | 知识图谱可视化 |
| 实时通信 | Socket.io-client | 4.x | WebSocket封装 |
| 路由管理 | Nuxt.js Router | 3.x | 单页面路由 |
| 请求库 | Axios | 1.x | HTTP请求封装 |
| 布局动画 | Konva.js | 9.x | 2D画布操作（设备布局） |
| 工具库 | lodash | 4.x | 数据处理工具 |
| 日期处理 | dayjs | 1.x | 时间格式化 |

### 1.2 前端项目结构

```
frontend/
├── guanlan/                      # 观澜前端项目
│   ├── assets/                   # 静态资源
│   │   ├── images/
│   │   └── styles/
│   ├── components/               # 通用组件
│   │   ├── DashboardCard/
│   │   ├── HeatMap/
│   │   ├── ImageWall/
│   │   └── TrendChart/
│   ├── layouts/                  # 布局组件
│   │   ├── BasicLayout.vue
│   │   └── DashboardLayout.vue
│   ├── pages/                    # 页面组件
│   │   ├── Overview/             # 生产总览
│   │   ├── Monitoring/           # 监控演示
│   │   ├── Tracing/              # 数据追溯
│   │   └── Login/
│   ├── plugins/                  # 插件
│   │   └── websocket.ts
│   ├── stores/                   # 状态管理
│   │   ├── user.ts
│   │   └── production.ts
│   ├── utils/                    # 工具函数
│   │   ├── request.ts
│   │   ├── format.ts
│   │   └── permission.ts
│   ├── nuxt.config.ts
│   └── package.json
│
├── sinan/                        # 司南前端项目
│   ├── components/
│   │   ├── KnowledgeGraph/       # 知识图谱
│   │   ├── SolutionTable/        # 方案对比表
│   │   ├── LayoutComparison/     # 布局对比
│   │   └── ROIChart/             # ROI可视化
│   ├── pages/
│   │   ├── AlertList/            # 异常列表
│   │   ├── Diagnosis/            # 诊断详情
│   │   ├── Solution/             # 处置方案
│   │   ├── Execution/            # 执行跟踪
│   │   └── CaseLibrary/          # 案例库
│   └── ...
│
└── shared/                       # 共享模块
    ├── components/               # 共享组件
    ├── utils/                    # 共享工具
    └── types/                    # TypeScript类型定义
```

### 1.3 关键组件设计

**知识图谱组件（KnowledgeGraph.vue）**

```vue
<template>
  <div ref="container" class="knowledge-graph-container"></div>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted, watch } from 'vue';
import G6, { Graph } from '@antv/g6';

interface Node {
  id: string;
  label: string;
  type: 'problem' | 'cause' | 'evidence';
  confidence?: number;
}

interface Edge {
  source: string;
  target: string;
  label?: string;
  type: 'causal' | 'correlation';
}

const props = defineProps<{
  nodes: Node[];
  edges: Edge[];
  centerNodeId: string;
  highlightPath?: string[];
}>();

const emit = defineEmits(['node-click']);

const container = ref<HTMLDivElement | null>(null);
let graph: Graph | null = null;

onMounted(() => {
  if (!container.value) return;

  graph = new G6.Graph({
    container: container.value,
    width: 800,
    height: 600,
    layout: {
      type: 'force',
      center: [400, 300],
      linkDistance: 150,
      nodeStrength: -50,
      edgeStrength: 0.1
    },
    modes: {
      default: ['drag-canvas', 'zoom-canvas', 'drag-node']
    },
    defaultNode: {
      type: 'circle',
      size: 40,
      style: {
        fill: '#5B8FF9',
        stroke: '#fff',
        lineWidth: 2
      },
      labelCfg: {
        position: 'bottom',
        style: { fontSize: 12 }
      }
    },
    defaultEdge: {
      type: 'line',
      style: {
        stroke: '#e2e2e2',
        lineWidth: 2,
        endArrow: true
      }
    }
  });

  // 数据转换
  const graphData = {
    nodes: props.nodes.map(node => ({
      id: node.id,
      label: node.label,
      style: {
        fill: node.type === 'problem' ? '#ff4d4f' :
              node.type === 'cause' ? '#faad14' : '#52c41a'
      }
    })),
    edges: props.edges.map(edge => ({
      source: edge.source,
      target: edge.target,
      label: edge.label,
      style: {
        stroke: edge.type === 'causal' ? '#1890ff' : '#bfbfbf',
        lineDash: edge.type === 'correlation' ? [5, 5] : undefined
      }
    }))
  };

  graph.data(graphData);
  graph.render();

  // 节点点击事件
  graph.on('node:click', (evt) => {
    const node = evt.item?.getModel();
    if (node) {
      emit('node-click', props.nodes.find(n => n.id === node.id));
    }
  });
});

onUnmounted(() => {
  graph?.destroy();
});

watch(() => props.highlightPath, (highlightPath = []) => {
  if (!graph || highlightPath.length === 0) return;

  graph.getEdges().forEach(edge => {
    const edgeModel = edge.getModel();
    const isHighlight = highlightPath.includes(edgeModel.source as string) &&
                        highlightPath.includes(edgeModel.target as string);

    graph!.updateItem(edge, {
      style: {
        stroke: isHighlight ? '#ff4d4f' : '#e2e2e2',
        lineWidth: isHighlight ? 3 : 2
      }
    });
  });
});
</script>
```

**布局对比组件（LayoutComparison.vue）**

```vue
<template>
  <div class="layout-comparison">
    <div class="layout-before">
      <h3>调整前布局</h3>
      <div ref="beforeRef" />
    </div>
    <div class="layout-after">
      <h3>调整后布局</h3>
      <div ref="afterRef" />
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted } from 'vue';
import Konva from 'konva';

interface Equipment {
  id: string;
  name: string;
  x: number;
  y: number;
  width: number;
  height: number;
}

const props = defineProps<{
  beforeLayout: Equipment[];
  afterLayout: Equipment[];
  showAnimation?: boolean;
}>();

const beforeRef = ref<HTMLDivElement | null>(null);
const afterRef = ref<HTMLDivElement | null>(null);

let beforeStage: Konva.Stage | null = null;
let afterStage: Konva.Stage | null = null;

onMounted(() => {
  if (!beforeRef.value || !afterRef.value) return;

  // Before布局
  beforeStage = new Konva.Stage({
    container: beforeRef.value,
    width: 600,
    height: 400
  });
  const beforeLayer = new Konva.Layer();

  props.beforeLayout.forEach(eq => {
    const rect = new Konva.Rect({
      x: eq.x,
      y: eq.y,
      width: eq.width,
      height: eq.height,
      fill: '#1890ff',
      stroke: '#000',
      strokeWidth: 2,
      cornerRadius: 5
    });

    const text = new Konva.Text({
      x: eq.x,
      y: eq.y + eq.height / 2 - 10,
      width: eq.width,
      text: eq.name,
      fontSize: 14,
      align: 'center',
      fill: '#fff'
    });

    beforeLayer.add(rect, text);
  });

  beforeStage.add(beforeLayer);

  // After布局（带动画）
  afterStage = new Konva.Stage({
    container: afterRef.value,
    width: 600,
    height: 400
  });
  const afterLayer = new Konva.Layer();

  props.afterLayout.forEach((eq, index) => {
    const beforeEq = props.beforeLayout[index];

    const rect = new Konva.Rect({
      x: props.showAnimation ? beforeEq.x : eq.x,
      y: props.showAnimation ? beforeEq.y : eq.y,
      width: eq.width,
      height: eq.height,
      fill: '#52c41a',
      stroke: '#000',
      strokeWidth: 2,
      cornerRadius: 5
    });

    const text = new Konva.Text({
      x: props.showAnimation ? beforeEq.x : eq.x,
      y: (props.showAnimation ? beforeEq.y : eq.y) + eq.height / 2 - 10,
      width: eq.width,
      text: eq.name,
      fontSize: 14,
      align: 'center',
      fill: '#fff'
    });

    if (props.showAnimation) {
      rect.to({
        x: eq.x,
        y: eq.y,
        duration: 1,
        easing: Konva.Easings.EaseInOut
      });

      text.to({
        x: eq.x,
        y: eq.y + eq.height / 2 - 10,
        duration: 1,
        easing: Konva.Easings.EaseInOut
      });
    }

    afterLayer.add(rect, text);
  });

  afterStage.add(afterLayer);
});

onUnmounted(() => {
  beforeStage?.destroy();
  afterStage?.destroy();
});
</script>
```

---

## 2. 后端技术栈详细设计

### 2.1 技术选型

| 技术分类 | 技术选型 | 版本 | 用途说明 |
|---------|---------|------|---------|
| 开发框架 | FastAPI | 0.100.x | Python企业级API框架 |
| 开发语言 | Python | 3.10+ | 脚本与类型安全 |
| ORM框架 | SQLAlchemy | 2.x | 数据库ORM |
| API风格 | RESTful + GraphQL | - | REST用于CRUD，GraphQL用于图谱查询（via strawberry或ariadne扩展） |
| 实时通信 | Starlette WebSocket | - | WebSocket服务 |
| 消息队列 | Celery + Redis | - | 异步任务与事件驱动 |
| 缓存 | Redis | 7.x | 数据缓存与会话 |
| 定时任务 | Celery Beat | - | 定时统计与清理 |
| 文档生成 | FastAPI Swagger | - | API文档自动生成 |
| 日志管理 | Loguru | 0.x | 结构化日志 |

### 2.2 后端项目结构

```
backend/
├── app/
│   ├── api/
│   │   ├── endpoints/
│   │   │   ├── production.py       # 生产模块
│   │   │   ├── quality.py          # 质量模块
│   │   │   ├── tracing.py          # 追溯模块
│   │   │   └── dashboard.py        # 仪表盘模块
│   │   └── deps.py                 # 依赖注入
│   ├── core/
│   │   ├── config.py               # 配置
│   │   ├── security.py             # 安全与认证
│   │   └── celery.py               # Celery配置
│   ├── crud/
│   │   ├── production.py
│   │   ├── anomaly.py
│   │   └── user.py
│   ├── db/
│   │   ├── models/
│   │   │   ├── production.py
│   │   │   ├── anomaly.py
│   │   │   └── user.py
│   │   ├── session.py              # 数据库会话
│   │   └── init_db.py              # 初始化
│   ├── graphql/                    # GraphQL扩展
│   │   ├── schema.py
│   │   └── resolvers.py
│   ├── schemas/
│   │   ├── production.py
│   │   ├── anomaly.py
│   │   └── user.py
│   ├── services/
│   │   ├── production.py
│   │   ├── diagnosis.py
│   │   └── solution.py
│   ├── tasks/
│   │   ├── simulation.py           # 异步仿真任务
│   │   └── notification.py         # 推送任务
│   ├── websocket/
│   │   └── endpoints.py            # WebSocket路由
│   ├── main.py
│   └── tests/
│
├── celery_worker.py
├── docker-compose.yml
├── requirements.txt
└── pyproject.toml
```

### 2.3 核心API设计

**生产总览API**

```python
# app/api/endpoints/production.py
from fastapi import APIRouter, Depends, Query
from sqlalchemy.ext.asyncio import AsyncSession

from app.schemas.production import ProductionOverview
from app.services.production import get_production_overview
from app.db.session import get_db
from app.core.security import get_current_user

router = APIRouter(prefix="/production", tags=["production"])

@router.get("/overview", response_model=ProductionOverview)
async def production_overview(
    line_id: str = Query(...),
    time_range: str = Query(...),
    db: AsyncSession = Depends(get_db),
    current_user = Depends(get_current_user)
):
    # 权限检查：假设使用模板内置RBAC
    if "production:view" not in current_user.permissions:
        raise HTTPException(status_code=403, detail="Permission denied")

    return await get_production_overview(db, line_id, time_range)

@router.get("/realtime-status")
async def realtime_status(
    line_id: str = Query(...),
    db: AsyncSession = Depends(get_db),
    current_user = Depends(get_current_user)
):
    if "production:view" not in current_user.permissions:
        raise HTTPException(status_code=403, detail="Permission denied")

    return await get_realtime_status(db, line_id)

@router.get("/bottleneck-analysis")
async def bottleneck_analysis(
    line_id: str = Query(...),
    start_time: str = Query(...),
    end_time: str = Query(...),
    db: AsyncSession = Depends(get_db),
    current_user = Depends(get_current_user)
):
    if "production:view" not in current_user.permissions:
        raise HTTPException(status_code=403, detail="Permission denied")

    return await get_bottleneck_analysis(db, line_id, start_time, end_time)
```

**知识图谱查询（GraphQL扩展，使用strawberry）**

```python
# app/graphql/schema.py
import strawberry
from strawberry.fastapi import GraphQLRouter

from app.services.diagnosis import build_knowledge_graph, get_evidence_chain
from app.core.security import get_current_user

@strawberry.type
class Node:
    id: str
    label: str
    type: str
    confidence: float | None = None

@strawberry.type
class Edge:
    source: str
    target: str
    label: str | None = None
    type: str

@strawberry.type
class KnowledgeGraph:
    nodes: list[Node]
    edges: list[Edge]
    center_node: str

@strawberry.type
class EvidenceChain:
    path: list[Node]
    edges: list[Edge]
    total_confidence: float

@strawberry.type
class Query:
    @strawberry.field
    async def knowledge_graph(
        self,
        problem_id: str,
        depth: int = 3,
        info: strawberry.Info
    ) -> KnowledgeGraph:
        current_user = info.context["user"]
        if "diagnosis:view" not in current_user.permissions:
            raise ValueError("Permission denied")
        return await build_knowledge_graph(problem_id, depth)

    @strawberry.field
    async def evidence_chain(
        self,
        problem_id: str,
        cause_id: str,
        info: strawberry.Info
    ) -> EvidenceChain:
        current_user = info.context["user"]
        if "diagnosis:view" not in current_user.permissions:
            raise ValueError("Permission denied")
        return await get_evidence_chain(problem_id, cause_id)

schema = strawberry.Schema(query=Query)
graphql_router = GraphQLRouter(schema)
```

### 2.4 实时通信设计

**WebSocket端点示例**

```python
# app/websocket/endpoints.py
from fastapi import APIRouter, WebSocket, Depends
from app.core.security import websocket_auth_dependency

router = APIRouter()

@router.websocket("/ws/notifications")
async def websocket_endpoint(
    websocket: WebSocket,
    current_user = Depends(websocket_auth_dependency)
):
    await websocket.accept()
    try:
        while True:
            data = await websocket.receive_text()
            # 处理消息，例如订阅主题
            if data == "subscribe:line":
                # 使用Redis pub/sub处理实时推送
                pass
    except WebSocketDisconnect:
        pass
```

### 2.5 异步任务设计

**Celery任务示例**

```python
# app/tasks/notification.py
from app.core.celery import celery_app
from app.services.notification import send_desktop_notification

@celery_app.task
def notify_user(user_id: str, message: str):
    send_desktop_notification(user_id, message)
```

### 2.6 安全设计

#### 2.6.1 认证守卫

模板内置JWT认证，使用`fastapi-users`扩展RBAC。

```python
# app/core/security.py
from fastapi_users.authentication import JWTStrategy
from fastapi_users import FastAPIUsers
from app.db.models.user import User
from app.schemas.user import UserRead

# 扩展RBAC检查
def has_permission(permission: str):
    async def dep(current_user: User = Depends(get_current_active_user)):
        if permission not in current_user.permissions:
            raise HTTPException(status_code=403, detail="Insufficient permissions")
        return current_user
    return dep
```

#### 2.6.2 数据权限过滤

```python
# app/services/production.py
async def get_production_lines(db: AsyncSession, current_user: User):
    query = select(ProductionLine)

    if current_user.role != "admin":
        query = query.where(ProductionLine.line_id.in_(current_user.line_ids))

    return await db.execute(query).scalars().all()
```