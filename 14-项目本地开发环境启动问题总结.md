# 观澜-司南项目本地开发环境启动问题总结

## 项目概述
观澜-司南是一个基于FastAPI + React的全栈智能决策支持平台，用于工业生产监控和异常检测。

## 遇到的问题及解决方案

### 1. 开发环境启动方式选择
**问题**: 用户希望本地启动前后端，但最初尝试使用Docker Compose。
**解决方案**: 切换到本地开发模式，前端使用`npm run dev`，后端使用`uv run uvicorn`。

### 2. FastAPI CLI工具缺失
**问题**: 本地运行`fastapi dev app/main.py`失败，提示需要安装`fastapi[standard]`。
**原因**: fastapi命令行工具需要额外依赖。
**解决方案**: 使用`uv run uvicorn app.main:app --reload`直接启动服务器。

### 3. 数据库连接问题
**问题**: 切换到本地开发后，后端无法连接数据库，用户反映"原来docker里的数据库怎么没有了"。
**原因**:
- Docker模式下数据库主机配置为"db"（容器名）
- 本地开发需要连接到Docker数据库容器，但使用不同的主机名
**解决方案**:
1. 单独启动Docker数据库容器: `docker compose up -d db`
2. 创建应用数据库: `docker exec guanlan-sina-db-1 psql -U postgres -c "CREATE DATABASE \"guanlan-sina\""`
3. 应用数据库迁移: `cd backend && uv run alembic upgrade head`
4. 修改连接方式：使用环境变量`POSTGRES_SERVER=host.docker.internal`

### 4. 依赖管理
**问题**: 需要安装Python和Node.js依赖。
**解决方案**:
- 后端: `cd backend && uv sync`
- 前端: `cd frontend && npm install`

### 5. 数据库迁移
**问题**: 数据库表结构需要通过Alembic迁移创建。
**解决方案**: 运行`alembic upgrade head`应用所有迁移。

## 当前状态
- ✅ 前端服务: http://localhost:5173 (正常运行)
- ✅ 后端服务: http://localhost:8000 (启动中，数据库连接待确认)
- ✅ 数据库: Docker PostgreSQL容器运行，迁移已应用
- ✅ Adminer: 可通过http://localhost:8080访问数据库管理界面

## 服务架构
```
前端 (React + Vite): localhost:5173
    ↓
后端 (FastAPI): localhost:8000
    ↓
数据库 (PostgreSQL): Docker容器 (host.docker.internal:5432)
```

## 推荐的本地开发启动流程

1. 启动数据库:
   ```bash
   docker compose up -d db
   docker exec guanlan-sina-db-1 psql -U postgres -c "CREATE DATABASE \"guanlan-sina\""
   cd backend && uv run alembic upgrade head
   ```

2. 启动后端:
   ```bash
   cd backend
   uv sync
   POSTGRES_SERVER=host.docker.internal uv run uvicorn app.main:app --reload
   ```

3. 启动前端:
   ```bash
   cd frontend
   npm install
   npm run dev
   ```

4. 验证服务:
   - 前端: http://localhost:5173
   - 后端API: http://localhost:8000/docs
   - 数据库管理: http://localhost:8080 (用户名: postgres, 密码: 123456)

## 关键配置说明
- 数据库连接: 通过`host.docker.internal`从本地连接Docker容器
- CORS: 前端localhost:5173已配置允许
- 环境变量: 从项目根目录的`.env`文件读取

## 注意事项
- 确保Docker Desktop运行以提供数据库服务
- 如果遇到端口冲突，可修改相应服务的端口配置
- 数据库迁移文件位于`backend/app/alembic/versions/`
- 前端API调用指向`http://localhost:8000`

## 故障排除
1. 如果数据库连接失败，检查`host.docker.internal`解析
2. 如果端口被占用，使用`netstat -ano | findstr :端口号`检查
3. 如果依赖安装失败，确保uv和npm版本兼容
4. 如果迁移失败，确保数据库存在且可访问
